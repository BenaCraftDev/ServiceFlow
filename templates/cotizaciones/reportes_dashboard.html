{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Reportes - Sistema de Cotizaciones</title>
    <link href="{% static 'css/main.css' %}" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
        .chart-container { 
            position: relative; 
            height: 300px; 
            width: 100%; 
        }
        .metric-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }
        .metric-card {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        /* EFECTOS HOVER PARA KPIS */
        .metric-card:hover {
            transform: translateY(-4px) scale(1.02);
            box-shadow: 0 12px 24px rgba(37, 117, 192, 0.2);
            border-color: var(--azul-500);
        }
        
        .metric-card:active {
            transform: translateY(-2px) scale(1.01);
        }
        
        .metric-icon {
            padding: 12px;
            border-radius: 12px;
            background: var(--azul-100);
            color: var(--azul-600);
            transition: all 0.3s ease;
        }
        
        .metric-card:hover .metric-icon {
            transform: scale(1.1) rotate(5deg);
            background: var(--azul-200);
        }
        
        .progress-bar {
            height: 8px;
            background: var(--gris-300);
            border-radius: 4px;
            overflow: hidden;
            flex: 1;
            margin: 0 8px;
        }
        .progress-fill {
            height: 100%;
            background: var(--azul-600);
            border-radius: 4px;
            transition: width 0.3s ease;
        }
        .legend-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px;
            cursor: pointer;
            transition: all 0.2s;
            border-radius: 8px;
        }
        .legend-item:hover {
            background: var(--azul-50);
            transform: translateX(4px);
        }
        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        /* ESTILOS MODAL EMPLEADO */
        .empleado-header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 24px;
            padding: 20px;
            background: linear-gradient(135deg, var(--azul-100), var(--blanco));
            border-radius: 12px;
        }
        
        .empleado-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--azul-600), var(--azul-500));
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            font-weight: 700;
            box-shadow: 0 4px 12px rgba(37, 117, 192, 0.3);
        }
        
        .empleado-info h3 {
            margin: 0 0 4px;
            color: var(--azul-700);
            font-size: 1.5rem;
        }
        
        .empleado-info p {
            margin: 0;
            color: var(--gris-600);
            font-size: 0.95rem;
        }
        
        .metricas-empleado {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }
        
        .metrica-empleado {
            background: var(--gris-100);
            padding: 16px;
            border-radius: 8px;
            text-align: center;
        }
        
        .metrica-empleado .valor {
            font-size: 2rem;
            font-weight: 700;
            color: var(--azul-700);
            margin: 8px 0 4px;
        }
        
        .metrica-empleado .label {
            font-size: 0.85rem;
            color: var(--gris-600);
        }
        
        .tabla-trabajos {
            width: 100%;
            border-collapse: collapse;
        }
        
        .tabla-trabajos th {
            background: var(--azul-100);
            padding: 12px;
            text-align: left;
            color: var(--azul-700);
            font-weight: 600;
        }
        
        .tabla-trabajos td {
            padding: 12px;
            border-bottom: 1px solid var(--gris-300);
        }
        
        .tabla-trabajos tr:hover {
            background: var(--gris-100);
        }
        
        .badge-estado-trabajo {
            padding: 4px 10px;
            border-radius: 999px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .badge-estado-trabajo.completado {
            background: var(--verde-100);
            color: var(--verde-600);
        }
        
        .badge-estado-trabajo.en-progreso {
            background: var(--azul-100);
            color: var(--azul-600);
        }
        
        .badge-estado-trabajo.pendiente {
            background: var(--naranja-100);
            color: var(--naranja-600);
        }
        .cliente-item, .servicio-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px;
            background: var(--gris-100);
            border-radius: var(--radius);
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .cliente-item:hover, .servicio-item:hover {
            background: var(--azul-50);
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }
        .filter-tabs {
            display: flex;
            background: var(--gris-100);
            border-radius: 12px;
            padding: 4px;
            gap: 4px;
        }
        .filter-tab {
            padding: 8px 16px;
            border-radius: 8px;
            background: transparent;
            border: none;
            cursor: pointer;
            font-weight: 600;
            color: var(--gris-600);
            transition: all 0.2s;
        }
        .filter-tab.active {
            background: white;
            color: var(--azul-600);
            box-shadow: var(--shadow);
        }
        .dashboard-grid {
            display: grid;
            gap: 20px;
        }
        .grid-2 {
            grid-template-columns: 2fr 1fr;
        }
        .grid-equal {
            grid-template-columns: 1fr 1fr;
        }
        @media (max-width: 900px) {
            .grid-2, .grid-equal {
                grid-template-columns: 1fr;
            }
            .metric-grid {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            }
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ESTILOS PARA MODALES INTERACTIVOS */
        .modal-interactivo {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .modal-interactivo.show { display: flex; }
        
        .modal-content-int {
            background: white;
            border-radius: 16px;
            width: 95%;
            max-width: 1200px;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
        }
        .modal-header-int {
            padding: 24px 32px;
            background: linear-gradient(135deg, var(--azul-700), var(--azul-500));
            color: white;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .modal-header-int h2 {
            margin: 0;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .modal-stats-int {
            display: flex;
            gap: 16px;
            font-size: 0.9rem;
            margin-top: 8px;
            flex-wrap: wrap;
        }
        .modal-stat {
            background: rgba(255, 255, 255, 0.15);
            padding: 6px 14px;
            border-radius: 8px;
            font-weight: 600;
        }
        .close-modal {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            font-size: 1.5rem;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s;
        }
        .close-modal:hover { 
            background: rgba(255, 255, 255, 0.3); 
            transform: rotate(90deg);
        }
        
        .modal-body-int {
            padding: 24px 32px;
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            min-width: 0;
            width: 100%;
            max-height: calc(90vh - 180px);
        }
        
        /* Scrollbar personalizado para modal */
        .modal-body-int::-webkit-scrollbar {
            width: 8px;
        }
        
        .modal-body-int::-webkit-scrollbar-track {
            background: var(--gris-100);
            border-radius: 4px;
        }
        
        .modal-body-int::-webkit-scrollbar-thumb {
            background: var(--azul-500);
            border-radius: 4px;
        }
        
        .modal-body-int::-webkit-scrollbar-thumb:hover {
            background: var(--azul-600);
        }
        
        /* MODAL CON DOS COLUMNAS */
        .modal-dos-columnas {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            height: calc(90vh - 250px);
            min-height: 400px;
            width: 100%;
        }
        
        .columna-modal {
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .columna-modal h3 {
            margin: 0 0 16px;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--azul-100);
            color: var(--azul-700);
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .columna-scroll {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding-right: 8px;
            height: 100%;
        }
        
        /* Scrollbar personalizado para cada columna */
        .columna-scroll::-webkit-scrollbar {
            width: 6px;
        }
        
        .columna-scroll::-webkit-scrollbar-track {
            background: var(--gris-100);
            border-radius: 3px;
        }
        
        .columna-scroll::-webkit-scrollbar-thumb {
            background: var(--azul-400);
            border-radius: 3px;
        }
        
        .columna-scroll::-webkit-scrollbar-thumb:hover {
            background: var(--azul-600);
        }
        
        .cotizacion-card {
            background: white;
            border: 1px solid var(--gris-200);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s;
            width: 100%;
            min-width: 0;
        }
        .cotizacion-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
            border-color: var(--azul-400);
        }
        .pill { 
            padding: 4px 12px; 
            border-radius: 12px; 
            font-size: 0.8rem; 
            font-weight: 600; 
            display: inline-block;
        }
        .pill.borrador { background: #fef3c7; color: #92400e; }
        .pill.enviada { background: #dbeafe; color: #1e40af; }
        .pill.aprobada { background: #dcfce7; color: #166534; }
        .pill.rechazada { background: #fee2e2; color: #991b1b; }
        .pill.vencida { background: #f3f4f6; color: #374151; }
        .pill.finalizada { background: #d1fae5; color: #065f46; }
        
        @media (max-width: 900px) {
            .modal-dos-columnas {
                grid-template-columns: 1fr;
            }
        }

</style>
</head>
<body>
    <!-- Modal para gr√°ficos interactivos -->
    <div id="modal-interactivo" class="modal-interactivo">
        <div class="modal-content-int">
            <div class="modal-header-int">
                <div>
                    <h2 id="modal-titulo"><i data-lucide="file-text"></i> <span></span></h2>
                    <div class="modal-stats-int" id="modal-stats"></div>
                </div>
                <button class="close-modal" onclick="cerrarModalInteractivo()">√ó</button>
            </div>
            <div class="modal-body-int" id="modal-contenido">
                <p style="text-align: center; color: var(--gris-600);">Cargando...</p>
            </div>
        </div>
    </div>

    {% include 'notificaciones/helmet.html' %}

    
    <!-- Main Content -->
    <main>
        <div id="reportes-dashboard">
            <div class="card">
                <div style="text-align: center; padding: 40px;">
                    <div style="display: inline-block; width: 48px; height: 48px; border: 4px solid var(--gris-300); border-top: 4px solid var(--azul-600); border-radius: 50%; animation: spin 1s linear infinite;"></div>
                    <p class="muted" style="margin-top: 16px;">Cargando datos...</p>
                </div>
            </div>
        </div>
    </main>
    
        
    <script>
        lucide.createIcons();
        
        const formatCurrency = (value) => {
            return new Intl.NumberFormat('es-CL', {
                style: 'currency',
                currency: 'CLP',
                minimumFractionDigits: 0
            }).format(value);
        };
        
        async function cargarDatos(periodo = 'mes-actual') {
            try {
                const response = await fetch(`{% url 'cotizaciones:datos_dashboard_reportes' %}?periodo=${periodo}`);
                const data = await response.json();
                if (data.error) throw new Error(data.error);
                return data;
            } catch (error) {
                console.error('Error al cargar datos:', error);
                return null;
            }
        }
        
        let chartEvolucion = null;
        let chartEstados = null;
        let filtroActual = 'mes-actual';
        let datosActuales = null;
        
        function destroyCharts() {
            if (chartEvolucion) {
                chartEvolucion.destroy();
                chartEvolucion = null;
            }
            if (chartEstados) {
                chartEstados.destroy();
                chartEstados = null;
            }
        }
        
        function renderDashboard(data) {
            datosActuales = data; // Guardar datos globalmente
            const container = document.getElementById('reportes-dashboard');
            
            container.innerHTML = `
            <!-- Header con filtros -->
                <div class="card">
                    <div class="actions" style="margin-bottom: 20px;">
                        <div class="actions-left" >
                            <h2 style="margin: 0; color: var(--azul-700);">Dashboard de Reportes</h2>
                        </div>
                        <div class="actions-right" style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
                            <select id="filtro-tipo" style="padding: 10px 12px; border: 1px solid var(--gris-300); border-radius: 8px; cursor: pointer;">
                                <option value="predefinido">Per√≠odo Predefinido</option>
                                <option value="mes">Por Mes</option>
                                <option value="ano">Por A√±o</option>
                            </select>
                            
                            <select id="filtro-periodo" style="padding: 10px 12px; border: 1px solid var(--gris-300); border-radius: 8px; cursor: pointer;">
                                <option value="mes-actual">Mes Actual</option>
                                <option value="mes-anterior">Mes Anterior</option>
                                <option value="trimestre">√öltimo Trimestre</option>
                                <option value="semestre">√öltimo Semestre</option>
                                <option value="ano">A√±o Actual</option>
                                <option value="todos">Hist√≥rico Completo</option>
                            </select>
                            
                            <select id="filtro-mes" style="padding: 10px 12px; border: 1px solid var(--gris-300); border-radius: 8px; cursor: pointer; display: none;">
                                <option value="">Seleccionar Mes</option>
                                <option value="1">Enero</option>
                                <option value="2">Febrero</option>
                                <option value="3">Marzo</option>
                                <option value="4">Abril</option>
                                <option value="5">Mayo</option>
                                <option value="6">Junio</option>
                                <option value="7">Julio</option>
                                <option value="8">Agosto</option>
                                <option value="9">Septiembre</option>
                                <option value="10">Octubre</option>
                                <option value="11">Noviembre</option>
                                <option value="12">Diciembre</option>
                            </select>
                            
                            <select id="filtro-ano" style="padding: 10px 12px; border: 1px solid var(--gris-300); border-radius: 8px; cursor: pointer; display: none;">
                                <option value="">Seleccionar A√±o</option>
                                ${Array.from({length: 6}, (_, i) => new Date().getFullYear() - i).map(year => 
                                    `<option value="${year}">${year}</option>`
                                ).join('')}
                            </select>
                            
                            <button id="btn-aplicar-filtro" style="padding: 10px 16px; background: var(--azul-600); color: white; border: none; border-radius: 8px; cursor: pointer; display: none; font-weight: 600;">
                                Aplicar
                            </button>
                            
                            <div class="filter-tabs">
                                <button class="filter-tab active" data-vista="general">General</button>
                                <button class="filter-tab" data-vista="empleados">Empleados</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- M√©tricas principales - AHORA CON ONCLICK Y DIN√ÅMICAS -->
                    <div class="metric-grid" id="metricas-principales" style="margin-bottom: 0px;">
                        ${renderMetricCardClickeable('Total Cotizaciones', data.metricasActuales.totalCotizaciones, 'file-text', 'var(--azul-600)', 'abrirModalTotalCotizaciones')}
                        ${renderMetricCardClickeable('üí∞ Dinero Te√≥rico', formatCurrency(data.metricasActuales.dineroTeorico || 0), 'trending-up', 'var(--verde-600)', 'abrirModalDineroTeorico')}
                        ${renderMetricCardClickeable('üíµ Ingresos Reales', formatCurrency(data.metricasActuales.ingresosReales || 0), 'dollar-sign', 'var(--verde-600)', 'abrirModalIngresosReales')}
                        ${renderMetricCardClickeable('Tasa Aprobaci√≥n', data.metricasActuales.tasaAprobacion + '%', 'check-circle', 'var(--naranja-600)', 'abrirModalTasaAprobacion')}
                        ${renderMetricCardClickeable('Ticket Promedio', formatCurrency(data.metricasActuales.ticketPromedio || 0), 'bar-chart-2', 'var(--azul-600)', 'abrirModalTicketPromedio')}
                    </div>
                </div>
                
                <div id="vista-general">
                    <!-- Gr√°ficos principales -->
                    <div class="dashboard-grid grid-2">
                        <!-- Evoluci√≥n mensual -->
                        <div class="card">
                            <h3>Evoluci√≥n de Cotizaciones <span style="font-size: 0.8rem; color: var(--gris-600); font-weight: normal;">(Click en un punto para ver detalles)</span></h3>
                            <div class="chart-container">
                                <canvas id="chart-evolucion"></canvas>
                            </div>
                        </div>
                        
                        <!-- Estados -->
                        <div class="card">
                            <h3>Estados de Cotizaciones</h3>
                            <div class="chart-container" style="height: 250px;">
                                <canvas id="chart-estados"></canvas>
                            </div>
                            <div id="leyenda-estados" style="margin-top: 16px;"></div>
                        </div>
                    </div>
                    
                    <!-- Top clientes y servicios -->
                    <div class="dashboard-grid grid-equal">
                        <div class="card">
                            <h3>Top 5 Clientes</h3>
                            <div id="top-clientes"></div>
                        </div>
                        
                        <div class="card">
                            <h3>Servicios M√°s Cotizados</h3>
                            <div id="servicios-cotizados"></div>
                        </div>
                    </div>
                </div>
                
                <div id="vista-empleados" style="display: none;">
                    <div class="card">
                        <h3>Empleados M√°s Productivos</h3>
                        <div class="table-wrap">
                            <table id="tabla-empleados">
                                <thead>
                                    <tr>
                                        <th>Empleado</th>
                                        <th>Trabajos</th>
                                        <th>Horas Total</th>
                                        <th>Tasa Completada</th>
                                        <th>Performance</th>
                                    </tr>
                                </thead>
                                <tbody id="empleados-tbody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
            
            // Renderizar componentes espec√≠ficos
            setTimeout(() => {
                renderCharts(data);
                renderTopClientes(data.topClientes);
                renderServiciosCotizados(data.serviciosCotizados);
                renderEstadosLeyenda(data.estadosCotizaciones);
                if (data.empleadosProductivos && data.empleadosProductivos.length > 0) {
                    renderEmpleados(data.empleadosProductivos);
                } else {
                    // Mostrar mensaje cuando no hay empleados
                    const tbody = document.getElementById('empleados-tbody');
                    if (tbody) {
                        tbody.innerHTML = `
                            <tr>
                                <td colspan="5" style="text-align: center; padding: 40px; color: var(--gris-600);">
                                    <i data-lucide="users" style="width: 48px; height: 48px; margin-bottom: 12px; opacity: 0.3;"></i>
                                    <p>No hay datos de empleados disponibles para el per√≠odo seleccionado</p>
                                    <p style="font-size: 0.85rem; margin-top: 8px;">Los datos de empleados se generan autom√°ticamente cuando se asignan trabajos.</p>
                                </td>
                            </tr>
                        `;
                    }
                }
                
                // Configurar filtros
                const filtroTipo = document.getElementById('filtro-tipo');
                const filtroPeriodo = document.getElementById('filtro-periodo');
                const filtroMes = document.getElementById('filtro-mes');
                const filtroAno = document.getElementById('filtro-ano');
                const btnAplicar = document.getElementById('btn-aplicar-filtro');
                
                // Restaurar valor seleccionado
                if (filtroPeriodo) {
                    filtroPeriodo.value = filtroActual;
                }
                
                // Cambiar tipo de filtro
                filtroTipo.addEventListener('change', () => {
                    const tipo = filtroTipo.value;
                    filtroPeriodo.style.display = tipo === 'predefinido' ? 'block' : 'none';
                    filtroMes.style.display = tipo === 'mes' ? 'block' : 'none';
                    filtroAno.style.display = (tipo === 'mes' || tipo === 'ano') ? 'block' : 'none';
                    btnAplicar.style.display = tipo !== 'predefinido' ? 'block' : 'none';
                    
                    if (tipo === 'predefinido') {
                        cargarYRenderizar(filtroPeriodo.value);
                    }
                });
                
                // Cambiar per√≠odo predefinido
                filtroPeriodo.addEventListener('change', async () => {
                    if (filtroTipo.value === 'predefinido') {
                        cargarYRenderizar(filtroPeriodo.value);
                    }
                });
                
                // Aplicar filtro personalizado
                btnAplicar.addEventListener('click', async () => {
                    const tipo = filtroTipo.value;
                    let periodo = '';
                    
                    if (tipo === 'mes') {
                        const mes = filtroMes.value;
                        const ano = filtroAno.value;
                        if (!mes || !ano) {
                            alert('Selecciona mes y a√±o');
                            return;
                        }
                        periodo = `mes-${mes}-${ano}`;
                    } else if (tipo === 'ano') {
                        const ano = filtroAno.value;
                        if (!ano) {
                            alert('Selecciona un a√±o');
                            return;
                        }
                        periodo = `ano-${ano}`;
                    }
                    
                    cargarYRenderizar(periodo);
                });
                
                // Cambiar vista General/Empleados
                document.querySelectorAll('.filter-tab').forEach(tab => {
                    tab.addEventListener('click', () => {
                        document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
                        tab.classList.add('active');
                        
                        const vista = tab.dataset.vista;
                        document.getElementById('vista-general').style.display = vista === 'general' ? 'block' : 'none';
                        document.getElementById('vista-empleados').style.display = vista === 'empleados' ? 'block' : 'none';
                        
                        // Cambiar m√©tricas seg√∫n la vista
                        cambiarMetricas(vista, data);
                    });
                });
                
                lucide.createIcons();
            }, 100);
        }
        
        async function cargarYRenderizar(periodo) {
            filtroActual = periodo;
            destroyCharts();
            document.getElementById('reportes-dashboard').innerHTML = `
                <div class="card">
                    <div style="text-align: center; padding: 40px;">
                        <div style="display: inline-block; width: 48px; height: 48px; border: 4px solid var(--gris-300); border-top: 4px solid var(--azul-600); border-radius: 50%; animation: spin 1s linear infinite;"></div>
                        <p class="muted" style="margin-top: 16px;">Cargando datos...</p>
                    </div>
                </div>
            `;
            const data = await cargarDatos(periodo);
            if (data) {
                renderDashboard(data);
            }
        }
        
        function renderMetricCardClickeable(titulo, valor, icon, color, funcionClick) {
            return `
                <div class="card metric-card" onclick="${funcionClick}()">
                    <div>
                        <p class="muted" style="margin: 0 0 8px; font-size: 0.85rem;">${titulo}</p>
                        <p class="kpi" style="margin: 0; color: ${color};">${valor}</p>
                    </div>
                    <div class="metric-icon" style="background: ${color}20; color: ${color};">
                        <i data-lucide="${icon}" style="width: 24px; height: 24px;"></i>
                    </div>
                </div>
            `;
        }
        
        function renderCharts(data) {
            destroyCharts();
            
            // Gr√°fico de evoluci√≥n CON INTERACTIVIDAD
            const ctxEvolucion = document.getElementById('chart-evolucion');
            if (ctxEvolucion) {
                chartEvolucion = new Chart(ctxEvolucion, {
                    type: 'line',
                    data: {
                        labels: data.cotizacionesMes.map(item => item.mes),
                        datasets: [
                            {
                                label: 'Cotizaciones',
                                data: data.cotizacionesMes.map(item => item.cotizaciones),
                                borderColor: '#2575c0',
                                backgroundColor: 'rgba(37, 117, 192, 0.1)',
                                fill: true,
                                tension: 0.4,
                                pointRadius: 5,
                                pointHoverRadius: 8,
                                pointBackgroundColor: '#2575c0',
                                pointBorderColor: '#fff',
                                pointBorderWidth: 2
                            },
                            {
                                label: 'Aprobadas',
                                data: data.cotizacionesMes.map(item => item.aprobadas),
                                borderColor: '#059669',
                                backgroundColor: 'rgba(5, 150, 105, 0.1)',
                                fill: true,
                                tension: 0.4,
                                pointRadius: 5,
                                pointHoverRadius: 8,
                                pointBackgroundColor: '#059669',
                                pointBorderColor: '#fff',
                                pointBorderWidth: 2
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        },
                        onClick: (event, activeElements) => {
                            if (activeElements.length > 0) {
                                const index = activeElements[0].index;
                                const mesLabel = data.cotizacionesMes[index].mes;
                                abrirModalEvolucionMes(mesLabel, data.cotizacionesMes[index]);
                            }
                        },
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    afterLabel: () => 'Click para ver detalles'
                                }
                            }
                        }
                    }
                });
            }
            
            // Gr√°fico de estados
            const ctxEstados = document.getElementById('chart-estados');
            if (ctxEstados) {
                chartEstados = new Chart(ctxEstados, {
                    type: 'doughnut',
                    data: {
                        labels: data.estadosCotizaciones.map(item => item.estado),
                        datasets: [{
                            data: data.estadosCotizaciones.map(item => item.valor),
                            backgroundColor: data.estadosCotizaciones.map(item => item.color),
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        onClick: (event, activeElements) => {
                            if (activeElements.length > 0) {
                                const index = activeElements[0].index;
                                const estado = data.estadosCotizaciones[index].estado;
                                abrirModalPorEstado(estado);
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const porcentaje = context.parsed;
                                        const totalCotizaciones = data.metricasActuales.totalCotizaciones || 0;
                                        const cantidad = Math.round((porcentaje * totalCotizaciones) / 100);
                                        return `${label}: ${cantidad}`;
                                    },
                                    afterLabel: () => 'Click para ver detalles'
                                }
                            }
                        }
                    }
                });
            }
        }
        
        function renderTopClientes(clientes) {
            const container = document.getElementById('top-clientes');
            if (!container) return;
            
            if (!clientes || clientes.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--gris-600);">
                        <i data-lucide="users" style="width: 48px; height: 48px; margin-bottom: 12px; opacity: 0.3;"></i>
                        <p>No hay datos de clientes disponibles</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = clientes.map(cliente => `
                <div class="cliente-item" data-cliente="${cliente.nombre}" onclick="abrirModalPorCliente(this.dataset.cliente)">
                    <div>
                        <h4 style="margin: 0 0 4px; color: var(--azul-700);">${cliente.nombre || 'Sin nombre'}</h4>
                        <p class="muted" style="margin: 0;">${cliente.cotizaciones || 0} cotizaciones</p>
                    </div>
                    <div style="text-align: right;">
                        <p style="margin: 0 0 4px; font-weight: 600; color: var(--azul-700);">${formatCurrency(cliente.valorTotal || 0)}</p>
                        <p class="muted" style="margin: 0; color: var(--verde-600);">${cliente.tasaAprobacion || 0}% aprobaci√≥n</p>
                    </div>
                </div>
            `).join('');
        }
        
        function renderServiciosCotizados(servicios) {
            const container = document.getElementById('servicios-cotizados');
            if (!container) return;
            
            if (!servicios || servicios.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--gris-600);">
                        <i data-lucide="wrench" style="width: 48px; height: 48px; margin-bottom: 12px; opacity: 0.3;"></i>
                        <p>No hay datos de servicios disponibles</p>
                    </div>
                `;
                return;
            }
            
            const maxCantidad = Math.max(...servicios.map(s => s.cantidad || 0));
            
            container.innerHTML = servicios.map(servicio => `
                <div class="servicio-item" data-servicio="${servicio.servicio}" onclick="abrirModalPorServicio(this.dataset.servicio)">
                    <div style="flex: 1;">
                        <h4 style="margin: 0 0 8px; color: var(--azul-700);">${servicio.servicio || 'Sin nombre'}</h4>
                        <div style="display: flex; align-items: center;">
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${maxCantidad > 0 ? ((servicio.cantidad || 0) / maxCantidad) * 100 : 0}%;"></div>
                            </div>
                            <span class="muted">${servicio.cantidad || 0}</span>
                        </div>
                    </div>
                    <div style="text-align: right; margin-left: 16px;">
                        <p style="margin: 0; font-weight: 600; color: var(--azul-700);">${formatCurrency(servicio.valor || 0)}</p>
                    </div>
                </div>
            `).join('');
        }
        
        function renderEstadosLeyenda(estados) {
            const container = document.getElementById('leyenda-estados');
            if (!container) return;
            
            container.innerHTML = estados.map(estado => `
                <div class="legend-item" onclick="abrirModalPorEstado('${estado.estado}')">
                    <div style="display: flex; align-items: center;">
                        <span class="legend-color" style="background: ${estado.color};"></span>
                        <span>${estado.estado}</span>
                    </div>
                    <strong>${estado.valor}%</strong>
                </div>
            `).join('');
        }
        
        // Funci√≥n para cambiar las m√©tricas seg√∫n la vista
        function cambiarMetricas(vista, data) {
            const metricasContainer = document.getElementById('metricas-principales');
            if (!metricasContainer) return;
            
            if (vista === 'empleados') {
                // Calcular m√©tricas de empleados
                const empleados = data.empleadosProductivos || [];
                const totalEmpleados = empleados.length;
                const totalTrabajos = empleados.reduce((sum, emp) => sum + (emp.trabajos || 0), 0);
                const totalHoras = empleados.reduce((sum, emp) => sum + (emp.horasTotal || 0), 0);
                const promedioTrabajosEmpleado = totalEmpleados > 0 ? Math.round(totalTrabajos / totalEmpleados) : 0;
                const promedioHorasEmpleado = totalEmpleados > 0 ? Math.round(totalHoras / totalEmpleados) : 0;
                const tasaPromedioCompletada = totalEmpleados > 0 
                    ? Math.round(empleados.reduce((sum, emp) => sum + (emp.tasaCompleta || 0), 0) / totalEmpleados) 
                    : 0;
                
                metricasContainer.innerHTML = `
                    ${renderMetricCard('üë• Total Empleados', totalEmpleados, 'users', 'var(--azul-600)')}
                    ${renderMetricCard('üìã Total Trabajos', totalTrabajos, 'clipboard-list', 'var(--verde-600)')}
                    ${renderMetricCard('‚è±Ô∏è Total Horas', totalHoras + ' hrs', 'clock', 'var(--naranja-600)')}
                    ${renderMetricCard('üìä Promedio Trabajos/Emp', promedioTrabajosEmpleado, 'bar-chart-2', 'var(--azul-600)')}
                    ${renderMetricCard('‚úÖ Tasa Completada', tasaPromedioCompletada + '%', 'check-circle', 'var(--verde-600)')}
                `;
            } else {
                // M√©tricas originales de cotizaciones
                metricasContainer.innerHTML = `
                    ${renderMetricCardClickeable('Total Cotizaciones', data.metricasActuales.totalCotizaciones, 'file-text', 'var(--azul-600)', 'abrirModalTotalCotizaciones')}
                    ${renderMetricCardClickeable('üí∞ Dinero Te√≥rico', formatCurrency(data.metricasActuales.dineroTeorico || 0), 'trending-up', 'var(--verde-600)', 'abrirModalDineroTeorico')}
                    ${renderMetricCardClickeable('üíµ Ingresos Reales', formatCurrency(data.metricasActuales.ingresosReales || 0), 'dollar-sign', 'var(--verde-600)', 'abrirModalIngresosReales')}
                    ${renderMetricCardClickeable('Tasa Aprobaci√≥n', data.metricasActuales.tasaAprobacion + '%', 'check-circle', 'var(--naranja-600)', 'abrirModalTasaAprobacion')}
                    ${renderMetricCardClickeable('Ticket Promedio', formatCurrency(data.metricasActuales.ticketPromedio || 0), 'bar-chart-2', 'var(--azul-600)', 'abrirModalTicketPromedio')}
                `;
            }
            
            lucide.createIcons();
        }
        
        // Funci√≥n auxiliar para renderizar metric card sin click
        function renderMetricCard(titulo, valor, icono, color) {
            return `
                <div class="card metric-card" style="pointer-events: none;">
                    <div>
                        <div style="font-size: 0.85rem; color: var(--gris-600); margin-bottom: 8px;">${titulo}</div>
                        <div style="font-size: 1.8rem; font-weight: 700; color: var(--azul-700);">${valor}</div>
                    </div>
                    <div class="metric-icon" style="background: ${color}20; color: ${color};">
                        <i data-lucide="${icono}" style="width: 24px; height: 24px;"></i>
                    </div>
                </div>
            `;
        }
        
        function renderEmpleados(empleados) {
            const tbody = document.getElementById('empleados-tbody');
            if (!tbody) return;
            
            if (!empleados || empleados.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 40px; color: var(--gris-600);">
                            <i data-lucide="users" style="width: 48px; height: 48px; margin-bottom: 12px; opacity: 0.3;"></i>
                            <p>No hay datos de empleados disponibles</p>
                        </td>
                    </tr>
                `;
                lucide.createIcons();
                return;
            }
            
            tbody.innerHTML = empleados.map(emp => {
                const tasaCompleta = emp.tasaCompleta || 0;
                return `
                    <tr style="cursor: pointer;" onclick="abrirModalEmpleado('${emp.nombre}', ${emp.trabajos}, ${emp.horasTotal || 0}, ${tasaCompleta})">
                        <td>${emp.nombre}</td>
                        <td>${emp.trabajos}</td>
                        <td>${emp.horasTotal || 0} hrs</td>
                        <td>${tasaCompleta}%</td>
                        <td>
                            <i data-lucide="${tasaCompleta >= 90 ? 'trending-up' : tasaCompleta >= 80 ? 'minus' : 'trending-down'}" 
                            style="color: ${tasaCompleta >= 90 ? 'var(--verde-600)' : tasaCompleta >= 80 ? 'var(--naranja-600)' : 'var(--rojo-600)'}; width: 20px; height: 20px;"></i>
                        </td>
                    </tr>
                `;
            }).join('');
            
            lucide.createIcons();
        }
        
        async function init() {
            const data = await cargarDatos();
            if (data) {
                renderDashboard(data);
                lucide.createIcons();
            } else {
                document.getElementById('reportes-dashboard').innerHTML = `
                    <div class="alert error">
                        <i data-lucide="alert-circle"></i>
                        <span>Error al cargar los datos del dashboard</span>
                    </div>
                `;
                lucide.createIcons();
            }
        }
        
        document.addEventListener('DOMContentLoaded', init);

        // ============== FUNCIONES PARA INTERACTIVIDAD ==============
        
        // Helper para prevenir el shift del contenido al abrir modal
        function abrirModalSinShift() {
            const scrollbarWidth = window.innerWidth - document.documentElement.clientWidth;
            
            // Crear elemento visual para reemplazar scrollbar
            if (scrollbarWidth > 0) {
                const scrollbarPlaceholder = document.createElement('div');
                scrollbarPlaceholder.id = 'scrollbar-placeholder';
                scrollbarPlaceholder.style.position = 'fixed';
                scrollbarPlaceholder.style.top = '0';
                scrollbarPlaceholder.style.right = '0';
                scrollbarPlaceholder.style.width = scrollbarWidth + 'px';
                scrollbarPlaceholder.style.height = '100vh';
                scrollbarPlaceholder.style.background = '#2c2c2c'; 
                scrollbarPlaceholder.style.zIndex = '999';
                document.body.appendChild(scrollbarPlaceholder);
            }
            
            document.body.style.overflow = 'hidden';
            document.body.style.paddingRight = scrollbarWidth + 'px';
        }
        
        window.cerrarModalInteractivo = function() {
            document.getElementById('modal-interactivo').classList.remove('show');
            document.body.style.overflow = '';
            document.body.style.paddingRight = '';
            
            // Remover placeholder de scrollbar
            const placeholder = document.getElementById('scrollbar-placeholder');
            if (placeholder) {
                placeholder.remove();
            }
        }
        
        // Funci√≥n para extraer mes y a√±o del label (ej: "Oct 24" -> mes=10, a√±o=2024)
        function parseMesLabel(mesLabel) {
            const mesesEsp = {
                'ene': 1, 'feb': 2, 'mar': 3, 'abr': 4, 'may': 5, 'jun': 6,
                'jul': 7, 'ago': 8, 'sep': 9, 'oct': 10, 'nov': 11, 'dic': 12
            };
            
            const mesesEng = {
                'jan': 1, 'feb': 2, 'mar': 3, 'apr': 4, 'may': 5, 'jun': 6,
                'jul': 7, 'aug': 8, 'sep': 9, 'oct': 10, 'nov': 11, 'dec': 12
            };
            
            const partes = mesLabel.toLowerCase().split(' ');
            const mesNombre = partes[0];
            const a√±oCorto = partes[1];
            
            // Intentar con espa√±ol primero, luego con ingl√©s
            const mes = mesesEsp[mesNombre] || mesesEng[mesNombre];
            const a√±o = parseInt('20' + a√±oCorto);
            
            return { mes, a√±o };
        }
        
        // NUEVA: Modal para gr√°fico de evoluci√≥n
        window.abrirModalEvolucionMes = async function(mesLabel, datosMes) {
            const { mes, a√±o } = parseMesLabel(mesLabel);
            
            const modal = document.getElementById('modal-interactivo');
            const titulo = document.getElementById('modal-titulo').querySelector('span');
            const stats = document.getElementById('modal-stats');
            const contenido = document.getElementById('modal-contenido');
            
            titulo.textContent = `Cotizaciones de ${mesLabel}`;
            contenido.innerHTML = '<p style="text-align: center;">Cargando...</p>';
            modal.classList.add('show');
            abrirModalSinShift();
            
            try {
                const response = await fetch(`/cotizaciones/api/cotizaciones-mes/?mes=${mes}&ano=${a√±o}`);
                const data = await response.json();
                
                // Validar que los datos existen
                if (!data.todas) {
                    throw new Error('Estructura de datos incorrecta');
                }
                
                stats.innerHTML = `
                    <div class="modal-stat">Total: ${data.total_count || 0}</div>
                    <div class="modal-stat">Aprobadas: ${data.aprobadas_count || 0}</div>
                    <div class="modal-stat">Valor: ${formatCurrency(data.valor_total || 0)}</div>
                    <div class="modal-stat">Tasa: ${data.tasa_aprobacion || 0}%</div>
                `;
                
                if (data.todas.length === 0 && data.aprobadas.length === 0) {
                    contenido.innerHTML = '<p style="text-align: center; padding: 40px;">No hay cotizaciones en este mes</p>';
                } else {
                    contenido.innerHTML = `
                        <div class="modal-dos-columnas">
                            <div class="columna-modal">
                                <h3>
                                    Todas las Cotizaciones
                                    <span class="pill" style="background: var(--azul-100); color: var(--azul-700);">${data.todas.length}</span>
                                </h3>
                                <div class="columna-scroll">
                                    ${data.todas.length > 0 ? data.todas.map(cot => `
                                        <div class="cotizacion-card" onclick="window.open('/cotizaciones/${cot.id}/', '_blank')">
                                            <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
                                                <strong>${cot.numero}</strong>
                                                <span class="pill ${cot.estado}">${cot.estado.toUpperCase()}</span>
                                            </div>
                                            <div><strong>${cot.cliente}</strong></div>
                                            <div style="color: var(--gris-600); font-size: 0.85rem; margin: 4px 0;">${cot.representante || 'Sin representante'}</div>
                                            <div style="color: var(--gris-600); margin: 8px 0; font-size: 0.9rem;">${cot.referencia || 'Sin referencia'}</div>
                                            <div style="display: flex; justify-content: space-between; padding-top: 12px; border-top: 1px solid var(--gris-200); font-size: 0.9rem;">
                                                <span style="font-weight: 600; color: var(--verde-600);">${formatCurrency(cot.valor_total)}</span>
                                                <span style="color: var(--gris-600);">${cot.fecha}</span>
                                            </div>
                                        </div>
                                    `).join('') : '<p style="text-align: center; color: var(--gris-600); padding: 20px;">No hay cotizaciones</p>'}
                                </div>
                            </div>
                            
                            <div class="columna-modal">
                                <h3>
                                    Aprobadas
                                    <span class="pill aprobada">${data.aprobadas.length}</span>
                                </h3>
                                <div class="columna-scroll">
                                    ${data.aprobadas.length > 0 ? data.aprobadas.map(cot => `
                                        <div class="cotizacion-card" onclick="window.open('/cotizaciones/${cot.id}/', '_blank')">
                                            <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
                                                <strong>${cot.numero}</strong>
                                                <span class="pill ${cot.estado}">${cot.estado.toUpperCase()}</span>
                                            </div>
                                            <div><strong>${cot.cliente}</strong></div>
                                            <div style="color: var(--gris-600); font-size: 0.85rem; margin: 4px 0;">${cot.representante || 'Sin representante'}</div>
                                            <div style="color: var(--gris-600); margin: 8px 0; font-size: 0.9rem;">${cot.referencia || 'Sin referencia'}</div>
                                            <div style="display: flex; justify-content: space-between; padding-top: 12px; border-top: 1px solid var(--gris-200); font-size: 0.9rem;">
                                                <span style="font-weight: 600; color: var(--verde-600);">${formatCurrency(cot.valor_total)}</span>
                                                <span style="color: var(--gris-600);">${cot.fecha}</span>
                                            </div>
                                        </div>
                                    `).join('') : '<p style="text-align: center; color: var(--gris-600); padding: 20px;">No hay cotizaciones aprobadas</p>'}
                                </div>
                            </div>
                        </div>
                    `;
                }
                lucide.createIcons();
            } catch (error) {
                console.error('‚ùå Error:', error);
                contenido.innerHTML = `<p style="text-align: center; color: red; padding: 40px;">Error al cargar datos: ${error.message}</p>`;
            }
        }
        
        // MODALES PARA KPIs
        window.abrirModalTotalCotizaciones = async function() {
            console.log('üìã Total Cotizaciones modal');
            const modal = document.getElementById('modal-interactivo');
            const titulo = document.getElementById('modal-titulo').querySelector('span');
            const stats = document.getElementById('modal-stats');
            const contenido = document.getElementById('modal-contenido');
            
            titulo.textContent = 'Todas las Cotizaciones del Per√≠odo';
            contenido.innerHTML = '<p style="text-align: center;">Cargando...</p>';
            modal.classList.add('show');
            abrirModalSinShift();
            
            try {
                const response = await fetch(`/cotizaciones/api/cotizaciones-por-estado/?estado=todas&periodo=${filtroActual}`);
                const data = await response.json();
                
                stats.innerHTML = `
                    <div class="modal-stat">Total: ${data.total}</div>
                    <div class="modal-stat">Valor: ${formatCurrency(data.valor_total)}</div>
                `;
                
                if (data.cotizaciones.length === 0) {
                    contenido.innerHTML = '<p style="text-align: center; padding: 40px;">No hay cotizaciones</p>';
                } else {
                    contenido.innerHTML = data.cotizaciones.map(cot => `
                        <div class="cotizacion-card" onclick="window.open('/cotizaciones/${cot.id}/', '_blank')">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
                                <strong>${cot.numero}</strong>
                                <span class="pill ${cot.estado}">${cot.estado.toUpperCase()}</span>
                            </div>
                            <div><strong>${cot.cliente}</strong></div>
                            <div style="color: var(--gris-600); margin: 8px 0;">${cot.referencia || 'Sin referencia'}</div>
                            <div style="display: flex; justify-content: space-between; padding-top: 12px; border-top: 1px solid var(--gris-200);">
                                <span style="font-weight: 600; color: var(--verde-600);">${formatCurrency(cot.valor_total)}</span>
                                <span style="color: var(--gris-600);">${cot.fecha}</span>
                            </div>
                        </div>
                    `).join('');
                }
                lucide.createIcons();
            } catch (error) {
                contenido.innerHTML = '<p style="text-align: center; color: red;">Error al cargar</p>';
            }
        }
        
        window.abrirModalDineroTeorico = async function() {
            console.log('üí∞ Dinero Te√≥rico modal');
            abrirModalPorEstado('Aprobada');
        }
        
        window.abrirModalIngresosReales = async function() {
            console.log('üíµ Ingresos Reales modal');
            abrirModalPorEstado('Finalizada');
        }
        
        window.abrirModalTasaAprobacion = async function() {
            console.log('‚úÖ Tasa Aprobaci√≥n modal');
            const modal = document.getElementById('modal-interactivo');
            const titulo = document.getElementById('modal-titulo').querySelector('span');
            const stats = document.getElementById('modal-stats');
            const contenido = document.getElementById('modal-contenido');
            
            titulo.textContent = 'Cotizaciones Aprobadas';
            contenido.innerHTML = '<p style="text-align: center;">Cargando...</p>';
            modal.classList.add('show');
            abrirModalSinShift();
            
            try {
                const response = await fetch(`/cotizaciones/api/cotizaciones-por-estado/?estado=Aprobada&periodo=${filtroActual}`);
                const data = await response.json();
                
                const total = datosActuales?.metricasActuales?.totalCotizaciones || 0;
                const tasaAprobacion = total > 0 ? Math.round((data.total / total) * 100) : 0;
                
                stats.innerHTML = `
                    <div class="modal-stat">Aprobadas: ${data.total}</div>
                    <div class="modal-stat">Total: ${total}</div>
                    <div class="modal-stat">Tasa: ${tasaAprobacion}%</div>
                    <div class="modal-stat">Valor: ${formatCurrency(data.valor_total)}</div>
                `;
                
                if (data.cotizaciones.length === 0) {
                    contenido.innerHTML = '<p style="text-align: center; padding: 40px;">No hay cotizaciones aprobadas</p>';
                } else {
                    contenido.innerHTML = data.cotizaciones.map(cot => `
                        <div class="cotizacion-card" onclick="window.open('/cotizaciones/${cot.id}/', '_blank')">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
                                <strong>${cot.numero}</strong>
                                <span class="pill ${cot.estado}">${cot.estado.toUpperCase()}</span>
                            </div>
                            <div><strong>${cot.cliente}</strong></div>
                            <div style="color: var(--gris-600); margin: 8px 0;">${cot.referencia || 'Sin referencia'}</div>
                            <div style="display: flex; justify-content: space-between; padding-top: 12px; border-top: 1px solid var(--gris-200);">
                                <span style="font-weight: 600; color: var(--verde-600);">${formatCurrency(cot.valor_total)}</span>
                                <span style="color: var(--gris-600);">${cot.fecha}</span>
                            </div>
                        </div>
                    `).join('');
                }
                lucide.createIcons();
            } catch (error) {
                contenido.innerHTML = '<p style="text-align: center; color: red;">Error al cargar</p>';
            }
        }
        
        window.abrirModalTicketPromedio = async function() {
            console.log('üìä Ticket Promedio modal');
            const modal = document.getElementById('modal-interactivo');
            const titulo = document.getElementById('modal-titulo').querySelector('span');
            const stats = document.getElementById('modal-stats');
            const contenido = document.getElementById('modal-contenido');
            
            titulo.textContent = 'Desglose de Valores';
            
            if (datosActuales) {
                const metricas = datosActuales.metricasActuales;
                const ticketPromedio = metricas.ticketPromedio || 0;
                const total = metricas.totalCotizaciones || 0;
                const valorTotal = metricas.valorTotal || 0;
                
                stats.innerHTML = `
                    <div class="modal-stat">Promedio: ${formatCurrency(ticketPromedio)}</div>
                    <div class="modal-stat">Cotizaciones: ${total}</div>
                    <div class="modal-stat">Valor Total: ${formatCurrency(valorTotal)}</div>
                `;
                
                // Mostrar top 10 cotizaciones por valor
                try {
                    const response = await fetch(`/cotizaciones/api/cotizaciones-por-estado/?estado=todas&periodo=${filtroActual}`);
                    const data = await response.json();
                    
                    // Ordenar por valor descendente
                    const topCotizaciones = data.cotizaciones
                        .sort((a, b) => b.valor_total - a.valor_total)
                        .slice(0, 10);
                    
                    contenido.innerHTML = `
                        <h3 style="margin-top: 0;">Top 10 Cotizaciones por Valor</h3>
                        ${topCotizaciones.map((cot, index) => `
                            <div class="cotizacion-card" onclick="window.open('/cotizaciones/${cot.id}/', '_blank')">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
                                    <strong>#${index + 1} - ${cot.numero}</strong>
                                    <span class="pill ${cot.estado}">${cot.estado.toUpperCase()}</span>
                                </div>
                                <div><strong>${cot.cliente}</strong></div>
                                <div style="color: var(--gris-600); margin: 8px 0;">${cot.referencia || 'Sin referencia'}</div>
                                <div style="display: flex; justify-content: space-between; padding-top: 12px; border-top: 1px solid var(--gris-200);">
                                    <span style="font-weight: 700; color: var(--verde-600); font-size: 1.1rem;">${formatCurrency(cot.valor_total)}</span>
                                    <span style="color: var(--gris-600);">${cot.fecha}</span>
                                </div>
                            </div>
                        `).join('')}
                    `;
                } catch (error) {
                    contenido.innerHTML = '<p style="text-align: center; color: red;">Error al cargar datos</p>';
                }
            }
            
            modal.classList.add('show');
            abrirModalSinShift();
            lucide.createIcons();
        }
        
        window.abrirModalPorEstado = async function(estado) {
            console.log('üîµ abrirModalPorEstado llamada con:', estado);
            const modal = document.getElementById('modal-interactivo');
            const titulo = document.getElementById('modal-titulo').querySelector('span');
            const stats = document.getElementById('modal-stats');
            const contenido = document.getElementById('modal-contenido');
            
            titulo.textContent = `Cotizaciones en estado: ${estado}`;
            contenido.innerHTML = '<p style="text-align: center;">Cargando...</p>';
            modal.classList.add('show');
            abrirModalSinShift();
            
            try {
                const response = await fetch(`/cotizaciones/api/cotizaciones-por-estado/?estado=${encodeURIComponent(estado)}&periodo=${filtroActual}`);
                const data = await response.json();
                
                stats.innerHTML = `
                    <div class="modal-stat">Total: ${data.total}</div>
                    <div class="modal-stat">Valor: ${formatCurrency(data.valor_total)}</div>
                `;
                
                if (data.cotizaciones.length === 0) {
                    contenido.innerHTML = '<p style="text-align: center; padding: 40px;">No hay cotizaciones en este estado</p>';
                } else {
                    contenido.innerHTML = data.cotizaciones.map(cot => `
                        <div class="cotizacion-card" onclick="window.open('/cotizaciones/${cot.id}/', '_blank')">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
                                <strong>${cot.numero}</strong>
                                <span class="pill ${cot.estado}">${cot.estado.toUpperCase()}</span>
                            </div>
                            <div><strong>${cot.cliente}</strong></div>
                            <div style="color: var(--gris-600); margin: 8px 0;">${cot.referencia || 'Sin referencia'}</div>
                            <div style="display: flex; justify-content: space-between; padding-top: 12px; border-top: 1px solid var(--gris-200);">
                                <span style="font-weight: 600; color: var(--verde-600);">${formatCurrency(cot.valor_total)}</span>
                                <span style="color: var(--gris-600);">${cot.fecha}</span>
                            </div>
                        </div>
                    `).join('');
                }
                lucide.createIcons();
            } catch (error) {
                contenido.innerHTML = '<p style="text-align: center; color: red;">Error al cargar</p>';
            }
        }
        
        window.abrirModalPorCliente = async function(cliente) {
            console.log('üü¢ abrirModalPorCliente llamada con:', cliente);
            const modal = document.getElementById('modal-interactivo');
            const titulo = document.getElementById('modal-titulo').querySelector('span');
            const stats = document.getElementById('modal-stats');
            const contenido = document.getElementById('modal-contenido');
            
            titulo.textContent = `Cotizaciones de: ${cliente}`;
            contenido.innerHTML = '<p style="text-align: center;">Cargando...</p>';
            modal.classList.add('show');
            abrirModalSinShift();
            
            try {
                const response = await fetch(`/cotizaciones/api/cotizaciones-por-cliente/?cliente=${encodeURIComponent(cliente)}&periodo=${filtroActual}`);
                const data = await response.json();
                
                stats.innerHTML = `
                    <div class="modal-stat">Total: ${data.total}</div>
                    <div class="modal-stat">Aprobadas: ${data.aprobadas}</div>
                    <div class="modal-stat">Tasa: ${data.tasa_aprobacion}%</div>
                    <div class="modal-stat">Valor: ${formatCurrency(data.valor_total)}</div>
                `;
                
                if (data.cotizaciones.length === 0) {
                    contenido.innerHTML = '<p style="text-align: center; padding: 40px;">No hay cotizaciones para este cliente</p>';
                } else {
                    contenido.innerHTML = data.cotizaciones.map(cot => `
                        <div class="cotizacion-card" onclick="window.open('/cotizaciones/${cot.id}/', '_blank')">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
                                <strong>${cot.numero}</strong>
                                <span class="pill ${cot.estado}">${cot.estado.toUpperCase()}</span>
                            </div>
                            <div><strong>${cot.cliente}</strong></div>
                            <div style="color: var(--gris-600); margin: 8px 0;">${cot.referencia || 'Sin referencia'}</div>
                            <div style="display: flex; justify-content: space-between; padding-top: 12px; border-top: 1px solid var(--gris-200);">
                                <span style="font-weight: 600; color: var(--verde-600);">${formatCurrency(cot.valor_total)}</span>
                                <span style="color: var(--gris-600);">${cot.fecha}</span>
                            </div>
                        </div>
                    `).join('');
                }
                lucide.createIcons();
            } catch (error) {
                contenido.innerHTML = '<p style="text-align: center; color: red;">Error al cargar</p>';
            }
        }
        
        window.abrirModalPorServicio = async function(servicio) {
            console.log('üü° abrirModalPorServicio llamada con:', servicio);
            const modal = document.getElementById('modal-interactivo');
            const titulo = document.getElementById('modal-titulo').querySelector('span');
            const stats = document.getElementById('modal-stats');
            const contenido = document.getElementById('modal-contenido');
            
            titulo.textContent = `Cotizaciones con: ${servicio}`;
            contenido.innerHTML = '<p style="text-align: center;">Cargando...</p>';
            modal.classList.add('show');
            abrirModalSinShift();
            
            try {
                const response = await fetch(`/cotizaciones/api/cotizaciones-por-servicio/?servicio=${encodeURIComponent(servicio)}&periodo=${filtroActual}`);
                const data = await response.json();
                
                stats.innerHTML = `
                    <div class="modal-stat">Cotizaciones: ${data.total}</div>
                    <div class="modal-stat">Cantidad total: ${data.cantidad_total}</div>
                    <div class="modal-stat">Valor: ${formatCurrency(data.valor_total)}</div>
                `;
                
                if (data.cotizaciones.length === 0) {
                    contenido.innerHTML = '<p style="text-align: center; padding: 40px;">No hay cotizaciones con este servicio</p>';
                } else {
                    contenido.innerHTML = data.cotizaciones.map(cot => `
                        <div class="cotizacion-card" onclick="window.open('/cotizaciones/${cot.id}/', '_blank')">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
                                <strong>${cot.numero}</strong>
                                <span class="pill ${cot.estado}">${cot.estado.toUpperCase()}</span>
                            </div>
                            <div><strong>${cot.cliente}</strong></div>
                            <div style="color: var(--gris-600); margin: 8px 0;">${cot.referencia || 'Sin referencia'}</div>
                            <div style="display: flex; justify-content: space-between; padding-top: 12px; border-top: 1px solid var(--gris-200);">
                                <span style="font-weight: 600; color: var(--verde-600);">${formatCurrency(cot.valor_total)}</span>
                                <span style="color: var(--gris-600);">${cot.fecha}</span>
                            </div>
                        </div>
                    `).join('');
                }
                lucide.createIcons();
            } catch (error) {
                contenido.innerHTML = '<p style="text-align: center; color: red;">Error al cargar</p>';
            }
        }
        
        // ============== MODAL EMPLEADO ==============
        window.abrirModalEmpleado = async function(nombre, trabajos, horasTotal, tasaCompleta) {
            console.log('üë§ abrirModalEmpleado:', nombre, trabajos, horasTotal, tasaCompleta);
            
            const modal = document.getElementById('modal-interactivo');
            const titulo = document.getElementById('modal-titulo').querySelector('span');
            const stats = document.getElementById('modal-stats');
            const contenido = document.getElementById('modal-contenido');
            
            titulo.textContent = `Desempe√±o de ${nombre}`;
            contenido.innerHTML = '<p style="text-align: center;">Cargando datos...</p>';
            stats.innerHTML = '';
            modal.classList.add('show');
            abrirModalSinShift();
            
            try {
                // Intentar obtener datos reales del backend
                const response = await fetch(`/cotizaciones/api/empleado/?nombre=${encodeURIComponent(nombre)}`);
                
                let datosEmpleado;
                if (response.ok) {
                    datosEmpleado = await response.json();
                    console.log('‚úÖ Datos reales del empleado:', datosEmpleado);
                } else {
                    // Si falla, usar datos simulados
                    console.log('‚ö†Ô∏è Usando datos simulados');
                    datosEmpleado = {
                        empleado: {
                            nombre: nombre,
                            cargo: 'T√©cnico',
                            rut: 'N/A',
                            email: 'N/A',
                            telefono: 'N/A',
                            fecha_ingreso: 'N/A',
                            activo: true
                        },
                        estadisticas: {
                            trabajos_totales: trabajos,
                            trabajos_completados: Math.round(trabajos * (tasaCompleta / 100)),
                            trabajos_pendientes: trabajos - Math.round(trabajos * (tasaCompleta / 100)),
                            horas_total: horasTotal,
                            promedio_horas_trabajo: trabajos > 0 ? (horasTotal / trabajos).toFixed(1) : 0,
                            tasa_completada: tasaCompleta
                        },
                        trabajos: [],
                        rendimiento_mensual: []
                    };
                }
                
                const emp = datosEmpleado.empleado;
                const stats_emp = datosEmpleado.estadisticas;
                
                // Header del empleado
                const iniciales = emp.nombre.split(' ').map(n => n[0]).join('').substring(0, 2);
                
                contenido.innerHTML = `
                    <div class="empleado-header">
                        <div class="empleado-avatar">${iniciales}</div>
                        <div class="empleado-info">
                            <h3>${emp.nombre}</h3>
                            <p>${emp.activo ? 'Empleado Activo' : 'Inactivo'} ‚Ä¢ Cargo: ${emp.cargo}</p>
                            <p style="font-size: 0.85rem; margin-top: 4px;">
                                ${emp.email !== 'N/A' ? `üìß ${emp.email}` : ''} 
                                ${emp.telefono !== 'N/A' ? `‚Ä¢ üìû ${emp.telefono}` : ''}
                            </p>
                        </div>
                    </div>
                    
                    <div class="metricas-empleado">
                        <div class="metrica-empleado">
                            <div class="label">Total Trabajos</div>
                            <div class="valor">${stats_emp.trabajos_totales}</div>
                        </div>
                        <div class="metrica-empleado">
                            <div class="label">Completados</div>
                            <div class="valor" style="color: var(--verde-600);">${stats_emp.trabajos_completados}</div>
                        </div>
                        <div class="metrica-empleado">
                            <div class="label">Pendientes</div>
                            <div class="valor" style="color: var(--naranja-600);">${stats_emp.trabajos_pendientes}</div>
                        </div>
                        <div class="metrica-empleado">
                            <div class="label">Horas Totales</div>
                            <div class="valor">${stats_emp.horas_total}</div>
                        </div>
                        <div class="metrica-empleado">
                            <div class="label">Promedio hrs/trabajo</div>
                            <div class="valor">${stats_emp.promedio_horas_trabajo}</div>
                        </div>
                        <div class="metrica-empleado">
                            <div class="label">Tasa Completada</div>
                            <div class="valor" style="color: ${stats_emp.tasa_completada >= 90 ? 'var(--verde-600)' : stats_emp.tasa_completada >= 80 ? 'var(--naranja-600)' : 'var(--rojo-600)'};">
                                ${stats_emp.tasa_completada}%
                            </div>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 24px;">
                        <div>
                            <h4 style="margin-bottom: 12px; color: var(--azul-700);">
                                <i data-lucide="activity" style="width: 18px; height: 18px; vertical-align: middle;"></i>
                                Rendimiento Mensual
                            </h4>
                            <div style="position: relative; height: 200px; max-height: 200px;">
                                <canvas id="chart-rendimiento-empleado"></canvas>
                            </div>
                        </div>
                        <div>
                            <h4 style="margin-bottom: 12px; color: var(--azul-700);">
                                <i data-lucide="pie-chart" style="width: 18px; height: 18px; vertical-align: middle;"></i>
                                Distribuci√≥n de Estados
                            </h4>
                            <div style="position: relative; height: 200px; max-height: 200px;">
                                <canvas id="chart-estados-empleado"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <h4 style="margin-bottom: 12px; color: var(--azul-700);">
                            <i data-lucide="list" style="width: 18px; height: 18px; vertical-align: middle;"></i>
                            ${datosEmpleado.trabajos.length > 0 ? '√öltimos Trabajos' : 'Trabajos Recientes (Simulados)'}
                        </h4>
                        <div style="max-height: 300px; overflow-y: auto;">
                            <table class="tabla-trabajos">
                                <thead>
                                    <tr>
                                        <th>Trabajo</th>
                                        <th>Cliente</th>
                                        <th>Horas</th>
                                        <th>Estado</th>
                                        <th>Fecha</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${datosEmpleado.trabajos.length > 0 
                                        ? generarTrabajosReales(datosEmpleado.trabajos)
                                        : generarTrabajosSimulados(stats_emp.trabajos_totales, emp.nombre)
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
                
                lucide.createIcons();
                
                // Crear gr√°ficos
                setTimeout(() => {
                    if (datosEmpleado.rendimiento_mensual.length > 0) {
                        crearGraficoRendimientoEmpleadoReal(datosEmpleado.rendimiento_mensual);
                    } else {
                        crearGraficoRendimientoEmpleado(stats_emp.trabajos_totales, stats_emp.tasa_completada);
                    }
                    crearGraficoEstadosEmpleado(stats_emp.trabajos_completados, stats_emp.trabajos_pendientes);
                }, 100);
                
            } catch (error) {
                console.error('Error al cargar empleado:', error);
                contenido.innerHTML = `<p style="text-align: center; color: red; padding: 40px;">Error al cargar datos del empleado</p>`;
            }
        }
        
        // Funci√≥n para renderizar trabajos reales del API
        function generarTrabajosReales(trabajos) {
            return trabajos.map(trabajo => `
                <tr>
                    <td>${trabajo.numero}</td>
                    <td>${trabajo.cliente}</td>
                    <td>${trabajo.horas} hrs</td>
                    <td><span class="badge-estado-trabajo ${trabajo.estado}">${trabajo.estado.replace('-', ' ').toUpperCase()}</span></td>
                    <td>${trabajo.fecha}</td>
                </tr>
            `).join('');
        }
        
        // Funci√≥n auxiliar para simular trabajos (cuando no hay datos reales)
        function generarTrabajosSimulados(totalTrabajos, nombreEmpleado) {
            const estados = ['completado', 'en-progreso', 'pendiente'];
            const clientes = ['Constructora ABC', 'Empresa XYZ', 'Corporaci√≥n 123', 'Servicios Del Sur', 'Industrias Norte'];
            const trabajos = [];
            
            const cantidad = Math.min(totalTrabajos, 10); // Mostrar m√°ximo 10
            
            for (let i = 0; i < cantidad; i++) {
                const estado = estados[Math.floor(Math.random() * estados.length)];
                const cliente = clientes[Math.floor(Math.random() * clientes.length)];
                const horas = (Math.random() * 8 + 1).toFixed(1);
                const diasAtras = Math.floor(Math.random() * 30);
                const fecha = new Date();
                fecha.setDate(fecha.getDate() - diasAtras);
                
                trabajos.push(`
                    <tr>
                        <td>Trabajo #${1000 + i}</td>
                        <td>${cliente}</td>
                        <td>${horas} hrs</td>
                        <td><span class="badge-estado-trabajo ${estado}">${estado.replace('-', ' ').toUpperCase()}</span></td>
                        <td>${fecha.toLocaleDateString('es-CL')}</td>
                    </tr>
                `);
            }
            
            return trabajos.join('');
        }
        
        // Gr√°fico con datos reales del API
        // Variable global para almacenar instancias de charts
        let chartRendimientoEmpleado = null;
        let chartEstadosEmpleado = null;
        
        function crearGraficoRendimientoEmpleadoReal(rendimientoMensual) {
            const ctx = document.getElementById('chart-rendimiento-empleado');
            if (!ctx) return;
            
            // Destruir gr√°fico anterior si existe
            if (chartRendimientoEmpleado) {
                chartRendimientoEmpleado.destroy();
                chartRendimientoEmpleado = null;
            }
            
            const labels = rendimientoMensual.map(r => r.mes);
            const data = rendimientoMensual.map(r => r.trabajos);
            
            chartRendimientoEmpleado = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Trabajos Completados',
                        data: data,
                        borderColor: 'rgb(37, 117, 192)',
                        backgroundColor: 'rgba(37, 117, 192, 0.1)',
                        tension: 0.4,
                        fill: true,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            enabled: true
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0,
                                stepSize: 1
                            },
                            max: Math.max(...data) + 5
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    },
                    animation: {
                        duration: 750
                    }
                }
            });
        }
        
        // Gr√°fico simulado (fallback)
        function crearGraficoRendimientoEmpleado(trabajos, tasaCompleta) {
            const ctx = document.getElementById('chart-rendimiento-empleado');
            if (!ctx) return;
            
            // Destruir gr√°fico anterior si existe
            if (chartRendimientoEmpleado) {
                chartRendimientoEmpleado.destroy();
                chartRendimientoEmpleado = null;
            }
            
            // Simular datos de los √∫ltimos 6 meses
            const labels = [];
            const data = [];
            for (let i = 5; i >= 0; i--) {
                const fecha = new Date();
                fecha.setMonth(fecha.getMonth() - i);
                labels.push(fecha.toLocaleDateString('es-CL', { month: 'short' }));
                data.push(Math.floor(Math.random() * 10 + 5)); // Trabajos por mes
            }
            
            chartRendimientoEmpleado = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Trabajos Completados',
                        data: data,
                        borderColor: 'rgb(37, 117, 192)',
                        backgroundColor: 'rgba(37, 117, 192, 0.1)',
                        tension: 0.4,
                        fill: true,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0,
                                stepSize: 1
                            },
                            max: Math.max(...data) + 5
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    },
                    animation: {
                        duration: 750
                    }
                }
            });
        }
        
        function crearGraficoEstadosEmpleado(completados, pendientes) {
            const ctx = document.getElementById('chart-estados-empleado');
            if (!ctx) return;
            
            // Destruir gr√°fico anterior si existe
            if (chartEstadosEmpleado) {
                chartEstadosEmpleado.destroy();
                chartEstadosEmpleado = null;
            }
            
            chartEstadosEmpleado = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Completados', 'Pendientes'],
                    datasets: [{
                        data: [completados, pendientes],
                        backgroundColor: [
                            'rgb(5, 150, 105)',
                            'rgb(234, 88, 12)'
                        ],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }
        
        // Cerrar modal con ESC o click fuera
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') cerrarModalInteractivo();
        });
        document.getElementById('modal-interactivo')?.addEventListener('click', (e) => {
            if (e.target.id === 'modal-interactivo') cerrarModalInteractivo();
        });

    </script>
</body>
</html>