{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Mis Notificaciones</title>
  <link rel="stylesheet" href="{% static 'css/main.css' %}">
</head>
<body>
  {% include 'notificaciones/helmet.html' %}

    <!-- Main Content -->
    <main>
      <!-- Header con stats -->
      <div class="notifications-page-header">
        <div>
          <h1>üì¨ Todas mis Notificaciones</h1>
          <div style="display: flex; gap: 16px; margin-top: 12px;">
            <span class="pill activo">Total: {{ stats.total }}</span>
            <span class="pill enviada">No le√≠das: {{ stats.no_leidas }}</span>
            <span class="pill aprobada">Importantes: {{ stats.importantes }}</span>
          </div>
        </div>
        
        <!-- Filtros -->
        <div class="notification-filters">
          <button class="filter-btn {% if filtro_actual == 'todas' %}active{% endif %}" 
                  onclick="filtrar('todas')">
            üìã Todas
          </button>
          <button class="filter-btn {% if filtro_actual == 'no_leidas' %}active{% endif %}" 
                  onclick="filtrar('no_leidas')">
            üîµ No le√≠das
          </button>
          <button class="filter-btn {% if filtro_actual == 'importantes' %}active{% endif %}" 
                  onclick="filtrar('importantes')">
            ‚≠ê Importantes
          </button>
        </div>
      </div>

      <!-- Actions -->
      <div class="actions" style="margin-bottom: 20px;">
        <div class="actions-left">
          <button class="btn secondary" onclick="marcarTodasLeidas()">
            ‚úì Marcar todas como le√≠das
          </button>
        </div>
        <div class="actions-right">
          <button class="btn warning" onclick="confirmarLimpiar()">
            üóëÔ∏è Limpiar antiguas
          </button>
        </div>
      </div>

      <!-- Notificaciones Card -->
      <div class="notifications-page-list">
        {% if notificaciones %}
          {% for notif in notificaciones %}
          <div class="notification-item {% if not notif.leida %}unread{% endif %}" 
               data-id="{{ notif.id }}" 
               data-url="{{ notif.url }}"
               style="padding: 20px 24px; position: relative; display: flex; gap: 12px;">
            
            <!-- Icono de tipo - Izquierda -->
            <div class="notification-type-icon {{ notif.tipo }}" style="flex-shrink: 0;">
              {% if notif.tipo == 'info' %}‚ÑπÔ∏è
              {% elif notif.tipo == 'success' %}‚úÖ
              {% elif notif.tipo == 'warning' %}‚ö†Ô∏è
              {% elif notif.tipo == 'danger' %}üö®
              {% endif %}
            </div>
            
            <!-- Contenido principal -->
            <div style="flex: 1; min-width: 0; display: flex; flex-direction: column; padding-right: 140px;">
              
              <!-- Fila 1: T√≠tulo + Estado + (Fecha y Estrella en esquina) -->
              <div style="display: flex; align-items: flex-start; gap: 12px; margin-bottom: 8px; position: relative;">
                <!-- T√≠tulo -->
                <h4 style="margin: 0; color: var(--azul-700); font-size: 1rem; flex: 1; min-width: 0;">
                  üéâ {{ notif.titulo }}
                </h4>
                
                <!-- Estado (Badge) -->
                {% if not notif.leida %}
                  <span class="pill enviada" style="font-size: 0.75rem; flex-shrink: 0;">üîµ No le√≠da</span>
                {% else %}
                  <span class="pill activo" style="font-size: 0.75rem; flex-shrink: 0;">‚úì Le√≠da</span>
                {% endif %}
              </div>
              
              <!-- Fila 2: Mensaje -->
              <p style="margin: 0 0 12px 0; color: var(--gris-800); line-height: 1.5;">
                {{ notif.mensaje }}
              </p>
              
              <!-- Fila 3: Bot√≥n "Ver detalle" + Importante badge (abajo izquierda) -->
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <div style="display: flex; gap: 8px; align-items: center;">
                  {% if notif.url %}
                  <a href="{{ notif.url }}" 
                     class="btn small secondary" 
                     onclick="marcarLeida({{ notif.id }}, event)">
                    Ver detalle ‚Üí
                  </a>
                  {% endif %}
                  
                  {% if notif.importante %}
                    <span class="pill aprobada" style="font-size: 0.75rem;">‚≠ê Importante</span>
                  {% endif %}
                </div>
              </div>
            </div>
            
            <!-- ESQUINA SUPERIOR DERECHA: Fecha + Estrella -->
            <div style="position: absolute; top: 20px; right: 24px; display: flex; gap: 8px; align-items: center;">
              <!-- Fecha -->
              <span style="font-size: 0.8rem; color: var(--gris-500); white-space: nowrap;">
                {{ notif.fecha_creacion|date:"d/m/y H:i" }}
              </span>
              
              <!-- Estrella -->
              <button class="btn-star {% if notif.importante %}starred{% endif %}" 
                      onclick="toggleImportante({{ notif.id }}, this); event.stopPropagation();"
                      title="{% if notif.importante %}Quitar de importantes{% else %}Marcar como importante{% endif %}">
                {% if notif.importante %}‚≠ê{% else %}‚òÜ{% endif %}
              </button>
            </div>
            
          </div>
          {% endfor %}
        {% else %}
          <div style="text-align: center; padding: 80px 20px; color: var(--gris-600);">
            <div style="font-size: 5rem; margin-bottom: 20px;">üì≠</div>
            <h3>No hay notificaciones</h3>
            <p>
              {% if filtro_actual == 'no_leidas' %}
                No tienes notificaciones sin leer
              {% elif filtro_actual == 'importantes' %}
                No has marcado ninguna notificaci√≥n como importante
              {% else %}
                Cuando recibas notificaciones aparecer√°n aqu√≠
              {% endif %}
            </p>
          </div>
        {% endif %}
      </div>
    </main>
  </div>

  <style>
    /* NOTIFICACI√ìN LE√çDA - Estilo sutil y apagado */
    .notification-item {
      background: var(--blanco);
      border-left: 3px solid var(--gris-300);
      transition: all 0.3s ease;
    }

    .notification-item:hover {
      background: var(--gris-100);
      border-left-color: var(--gris-400);
    }

    /* NOTIFICACI√ìN NO LE√çDA - Destacada con azul */
    .notification-item.unread {
      background: linear-gradient(90deg, rgba(37, 117, 192, 0.08), var(--blanco));
      border-left: 4px solid var(--azul-600);
      box-shadow: 0 2px 8px rgba(37, 117, 192, 0.12);
    }

    .notification-item.unread:hover {
      background: linear-gradient(90deg, rgba(37, 117, 192, 0.12), var(--gris-100));
      border-left-color: var(--azul-700);
    }

    /* Sin punto indicador - removido para evitar confusi√≥n */

    /* T√≠tulos */
    .notification-item h4 {
      color: var(--gris-700);
    }

    .notification-item.unread h4 {
      color: var(--azul-700);
      font-weight: 700;
    }

    /* Mensaje */
    .notification-item p {
      color: var(--gris-600);
    }

    .notification-item.unread p {
      color: var(--gris-800);
    }

    /* Bot√≥n de estrella - Compacto */
    .btn-star {
      background: transparent;
      border: 2px solid var(--gris-400);
      color: var(--gris-500);
      font-size: 1.1rem;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
      flex-shrink: 0;
    }

    .btn-star:hover {
      border-color: var(--naranja-600);
      color: var(--naranja-600);
      transform: scale(1.1);
      background: rgba(234, 88, 12, 0.1);
    }

    .btn-star.starred {
      border-color: var(--naranja-600);
      color: var(--naranja-600);
      background: linear-gradient(135deg, #fffbeb, #fef3c7);
      animation: starPulse 2s ease-in-out infinite;
    }

    @keyframes starPulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    .btn-star:active {
      transform: scale(0.95);
    }

    /* Icono de tipo - m√°s sutil en le√≠das */
    .notification-type-icon {
      opacity: 0.6;
      transition: opacity 0.3s ease;
    }

    .notification-item.unread .notification-type-icon {
      opacity: 1;
    }
  </style>

  <script>
    // Marcar como le√≠da
    function marcarLeida(id, event) {
      event.preventDefault();
      fetch(`/notificaciones/marcar-leida/${id}/`, {
        method: 'POST',
        headers: {
          'X-CSRFToken': getCookie('csrftoken'),
        }
      }).then(() => {
        window.location.href = event.target.href;
      });
    }

    // Marcar todas como le√≠das
    function marcarTodasLeidas() {
      if (!confirm('¬øMarcar todas las notificaciones como le√≠das?')) return;
      
      fetch("{% url 'notificaciones:marcar_todas_leidas' %}", {
        method: 'POST',
        headers: {
          'X-CSRFToken': getCookie('csrftoken'),
        }
      }).then(() => {
        location.reload();
      });
    }

    // Toggle importante (estrella)
    function toggleImportante(id, button) {
      event.stopPropagation();
      
      fetch(`/notificaciones/toggle-importante/${id}/`, {
        method: 'POST',
        headers: {
          'X-CSRFToken': getCookie('csrftoken'),
        }
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          // Actualizar UI
          if (data.importante) {
            button.classList.add('starred');
            button.innerHTML = '‚≠ê';
            button.title = 'Quitar de importantes';
          } else {
            button.classList.remove('starred');
            button.innerHTML = '‚òÜ';
            button.title = 'Marcar como importante';
          }
        }
      })
      .catch(err => console.error('Error:', err));
    }

    // Filtrar notificaciones
    function filtrar(tipo) {
      window.location.href = `{% url 'notificaciones:lista' %}?filtro=${tipo}`;
    }

    // Confirmar limpieza
    function confirmarLimpiar() {
      if (!confirm('¬øEliminar notificaciones le√≠das de hace m√°s de 6 meses (excepto importantes)?')) return;
      
      fetch("{% url 'notificaciones:limpiar' %}", {
        method: 'POST',
        headers: {
          'X-CSRFToken': getCookie('csrftoken'),
        }
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          alert(data.mensaje);
          location.reload();
        }
      })
      .catch(err => {
        console.error('Error:', err);
        alert('Ocurri√≥ un error al limpiar las notificaciones');
      });
    }

    // Obtener CSRF token
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }
  </script>
</body>
</html>