{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Enviar Cotizaci√≥n por Email - Sistema de Cotizaciones</title>
  <link rel="stylesheet" href="{% static 'css/main.css' %}">
  <style>
    /* Loading overlay */
    .loading-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 9999;
      justify-content: center;
      align-items: center;
    }
    
    .loading-overlay.active {
      display: flex;
    }
    
    .loading-content {
      background: white;
      padding: 40px;
      border-radius: 12px;
      text-align: center;
      max-width: 400px;
    }
    
    .loading-spinner {
      width: 60px;
      height: 60px;
      border: 5px solid #e2e8f0;
      border-top-color: var(--azul-600);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .loading-text {
      font-size: 1.1rem;
      color: var(--azul-700);
      font-weight: 600;
      margin-bottom: 10px;
    }
    
    .loading-subtext {
      font-size: 0.9rem;
      color: var(--gris-600);
    }
    
    /* Alerta de configuraci√≥n */
    .config-warning {
      background: #fffbeb;
      border: 2px solid #fbbf24;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 20px;
      display: flex;
      gap: 12px;
      align-items: start;
    }
    
    .config-warning-icon {
      font-size: 1.5rem;
      color: #f59e0b;
    }
  </style>
</head>
<body>
  <!-- Loading overlay -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-content">
      <div class="loading-spinner"></div>
      <div class="loading-text">Enviando cotizaci√≥n...</div>
      <div class="loading-subtext">Esto puede tomar unos segundos. Por favor, espere.</div>
    </div>
  </div>

  <!-- Header -->
  <div class="topbar">
    <div class="logo">
      üìß Enviar Cotizaci√≥n
      <span class="badge">{{ cotizacion.numero }}</span>
    </div>
    <div class="spacer"></div>
    <div class="user-menu">
      <a href="{% url 'cotizaciones:detalle' cotizacion.pk %}">üëÅÔ∏è Ver Cotizaci√≥n</a>
      <a href="{% url 'cotizaciones:lista' %}">üìÑ Lista</a>
    </div>
  </div>

  <div class="container">
    {% if not config_email_valida %}
    <div class="config-warning">
      <div class="config-warning-icon">‚ö†Ô∏è</div>
      <div>
        <strong>Advertencia: Configuraci√≥n de Email Incompleta</strong>
        <p style="margin: 8px 0 0;">
          El sistema de email no est√° completamente configurado. 
          Es posible que el env√≠o falle. Contacte al administrador del sistema.
        </p>
      </div>
    </div>
    {% endif %}

    <div class="card">
      <h3>üìß Enviar Cotizaci√≥n por Email</h3>
      
      <!-- Info de la cotizaci√≥n -->
      <div style="background: var(--azul-100); padding: 16px; border-radius: 8px; margin-bottom: 20px;">
        <h4 style="margin: 0 0 10px;">Cotizaci√≥n N¬∞ {{ cotizacion.numero }}</h4>
        <p style="margin: 5px 0;"><strong>Cliente:</strong> {{ cotizacion.get_nombre_cliente }}</p>
        <p style="margin: 5px 0;"><strong>Referencia:</strong> {{ cotizacion.referencia|truncatewords:10 }}</p>
        <p style="margin: 5px 0;"><strong>Valor Total:</strong> ${{ cotizacion.valor_total|floatformat:0 }}</p>
      </div>

      <form method="post" id="emailForm">
        {% csrf_token %}
        
        <div class="form-group">
          <label for="email">Email del Cliente *</label>
          <input 
            type="email" 
            id="email" 
            name="email" 
            required
            value="{{ email_sugerido }}"
            placeholder="cliente@ejemplo.com">
          <small style="color: var(--gris-600);">
            El cliente recibir√° la cotizaci√≥n y podr√° responder directamente desde el email
          </small>
        </div>

        <div class="form-group">
          <label for="mensaje_adicional">Mensaje Adicional (Opcional)</label>
          <textarea 
            id="mensaje_adicional" 
            name="mensaje_adicional" 
            rows="5"
            placeholder="Agregue un mensaje personalizado que se incluir√° en el email..."></textarea>
        </div>

        <div class="form-group">
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                <input 
                    type="checkbox" 
                    name="enviar_copia" 
                    checked
                    style="width: auto; cursor: pointer;"
                >
                <span>Enviar copia a mi correo ({{ request.user.email }})</span>
            </label>
            <small class="muted">Recibir√°s una copia del email enviado al cliente</small>
        </div>

        <!-- Preview de lo que se enviar√° -->
        <div style="background: var(--gris-100); padding: 16px; border-radius: 8px; margin-top: 20px;">
          <h4 style="margin: 0 0 10px;">‚úÖ El cliente recibir√°:</h4>
          <ul style="margin: 10px 0; padding-left: 20px;">
            <li>‚úâÔ∏è Email con los detalles de la cotizaci√≥n</li>
            <li>üëÅÔ∏è Enlace para ver la cotizaci√≥n completa</li>
            <li>‚úÖ Bot√≥n para aprobar la cotizaci√≥n</li>
            <li>üìù Bot√≥n para solicitar cambios</li>
            <li>‚ùå Bot√≥n para rechazar</li>
          </ul>
          <p style="margin: 10px 0 0; color: var(--gris-600); font-size: 0.9rem;">
            <strong>Nota:</strong> Una vez enviada, recibir√°s una notificaci√≥n autom√°tica cuando el cliente responda.
          </p>
        </div>

        <div style="display: flex; gap: 10px; margin-top: 30px; justify-content: flex-end;">
          <a href="{% url 'cotizaciones:detalle' cotizacion.pk %}" class="btn secondary">
            ‚ùå Cancelar
          </a>
          <button type="submit" class="btn success" id="submitBtn">
            üìß Enviar Cotizaci√≥n
          </button>
        </div>
      </form>
    </div>

    <!-- Informaci√≥n adicional -->
    <div class="card">
      <h3>‚ÑπÔ∏è Informaci√≥n Importante</h3>
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px;">
        <div>
          <h4 style="color: var(--azul-600); margin: 0 0 8px;">üîí Seguridad</h4>
          <p style="margin: 0; color: var(--gris-600); font-size: 0.9rem;">
            Se generar√° un enlace √∫nico y seguro para que el cliente pueda responder sin necesidad de login.
          </p>
        </div>
        <div>
          <h4 style="color: var(--azul-600); margin: 0 0 8px;">üì¨ Notificaciones</h4>
          <p style="margin: 0; color: var(--gris-600); font-size: 0.9rem;">
            Recibir√°s un email autom√°ticamente cuando el cliente apruebe, rechace o solicite cambios.
          </p>
        </div>
        <div>
          <h4 style="color: var(--azul-600); margin: 0 0 8px;">üìä Estado</h4>
          <p style="margin: 0; color: var(--gris-600); font-size: 0.9rem;">
            La cotizaci√≥n cambiar√° autom√°ticamente a "Enviada" y no podr√° ser editada hasta recibir respuesta.
          </p>
        </div>
      </div>
    </div>

    <!-- Tips para problemas comunes -->
    <div class="card">
      <h3>üí° Soluci√≥n de Problemas</h3>
      <div style="color: var(--gris-600); font-size: 0.9rem;">
        <p><strong>Si el env√≠o falla:</strong></p>
        <ul style="margin: 10px 0; padding-left: 20px;">
          <li>Verifica que el email del cliente est√© correcto</li>
          <li>Intenta nuevamente en unos segundos (puede haber problemas temporales de conexi√≥n)</li>
          <li>Si el problema persiste, contacta al administrador del sistema</li>
        </ul>
        <p style="margin-top: 15px;"><strong>Tiempo de espera:</strong></p>
        <ul style="margin: 10px 0; padding-left: 20px;">
          <li>El env√≠o puede tomar hasta 30 segundos</li>
          <li>No cierres esta ventana hasta ver el mensaje de confirmaci√≥n</li>
        </ul>
      </div>
    </div>
  </div>

  <script>
    // Mostrar loading overlay al enviar formulario
    document.getElementById('emailForm').addEventListener('submit', function(e) {
      const submitBtn = document.getElementById('submitBtn');
      const loadingOverlay = document.getElementById('loadingOverlay');
      
      // Deshabilitar bot√≥n
      submitBtn.disabled = true;
      submitBtn.style.opacity = '0.6';
      submitBtn.style.cursor = 'not-allowed';
      
      // Mostrar loading
      loadingOverlay.classList.add('active');
    });

    // Si hay error, permitir reenv√≠o
    window.addEventListener('pageshow', function(event) {
      const submitBtn = document.getElementById('submitBtn');
      const loadingOverlay = document.getElementById('loadingOverlay');
      
      submitBtn.disabled = false;
      submitBtn.style.opacity = '1';
      submitBtn.style.cursor = 'pointer';
      loadingOverlay.classList.remove('active');
    });
  </script>
</body>
</html>