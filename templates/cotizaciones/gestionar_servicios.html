{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Gestionar Servicios - Sistema de Cotizaciones</title>
  <link rel="stylesheet" href="{% static 'css/main.css' %}">
</head>
<body>
  {% include 'notificaciones/helmet.html' %}

    <main>

      <div class="cards">
        <div class="card" id="kpi-total-servicios">
          <h4>Total Servicios</h4>
          <div class="kpi" id="count-total">{{ servicios|length }}</div>
          <div class="muted">Disponibles</div>
        </div>

        <div class="card" id="kpi-categorias">
          <h4>Categor√≠as</h4>
          <div class="kpi" id="count-categorias">{{ categories|length }}</div>
          <div class="muted">En uso</div>
        </div>

        <div class="card" id="kpi-inactivos">
          <h4>Inactivos</h4>
          <div class="kpi" id="count-inactivos">-</div>
          <div class="muted">Fuera de uso</div>
        </div>

        <div class="card" id="kpi-promedio">
          <h4>Valor Promedio</h4>
          <div class="kpi" id="valor-promedio-display">$0</div>
          <div class="muted">Click para ordenar</div>
        </div>
      </div>

      <div class="actions">
        <div class="actions-left">
          <h1 style="margin: 0; color: var(--azul-700);">Cat√°logo de Servicios</h1>
        </div>
        <div class="actions-right">
          <div class="dropdown-export" style="position: relative; display: inline-block;">
            <button type="button" class="btn secondary" onclick="toggleExportMenu('export-servicios')">
              üì• Exportar
            </button>
            <div id="export-servicios" class="export-menu" style="display: none;">
              <a href="{% url 'cotizaciones:exportar_servicios' %}?formato=excel{% if categoria_filtro %}&categoria={{ categoria_filtro }}{% endif %}">
                üìä Exportar a Excel
              </a>
              <a href="{% url 'cotizaciones:exportar_servicios' %}?formato=csv{% if categoria_filtro %}&categoria={{ categoria_filtro }}{% endif %}">
                üìÑ Exportar a CSV
              </a>
            </div>
          </div>
          <button type="button" class="btn" onclick="mostrarModal('modal-servicio')">
            ‚ûï Nuevo Servicio
          </button>
          <button type="button" class="btn secondary" onclick="mostrarModal('modal-ver-categorias')">
            üè∑Ô∏è Categor√≠as
          </button>
        </div>
      </div>

      <div class="filters">
        <div class="filter-group">
          <label for="categoria">Categor√≠a</label>
          <select id="categoria" name="categoria">
            <option value="">Todas las categor√≠as</option>
            {% for categoria in categorias %}
              <option value="{{ categoria.id }}" 
                      {% if categoria.id|stringformat:"s" == categoria_filtro %}selected{% endif %}>
                {{ categoria.nombre }}
              </option>
            {% endfor %}
          </select>
        </div>
        
        <div class="filter-group">
          <label for="filtro-estado">Estado</label>
          <select id="filtro-estado">
            <option value="">Todos</option>
            <option value="activo">Activo</option>
            <option value="inactivo">Inactivo</option>
          </select>
        </div>
        
        <div class="filter-group">
          <label for="busqueda">Buscar Servicio</label>
          <input type="text" id="busqueda" name="busqueda" value="{{ busqueda }}" 
                placeholder="Nombre, descripci√≥n...">
        </div>
        
        <div class="filter-group" style="align-self: end;">
          <button type="button" class="btn secondary" onclick="limpiarTodoYResetear()">
            üóëÔ∏è Limpiar
          </button>
        </div>
      </div>

      <div class="table-wrap">
        <table id="tabla-servicios">
          <thead>
            <tr>
              <th>Servicio</th>
              <th>Categor√≠a</th>
              <th>Precio Base</th>
              <th>Unidad</th>
              <th>Estado</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            {% for servicio in servicios %}
            <tr data-estado="{% if servicio.activo %}activo{% else %}inactivo{% endif %}"
                data-categoria="{{ servicio.categoria.id }}"
                data-precio="{{ servicio.precio_base|stringformat:'f' }}">
              <td>
                <strong>{{ servicio.nombre }}</strong>
                <div style="font-size: 0.85rem; color: var(--gris-600); margin-top: 4px;">
                  {{ servicio.descripcion|truncatewords:15 }}
                </div>
              </td>
              <td>
                <span class="pill enviada">{{ servicio.categoria.nombre }}</span>
              </td>
              <td><strong>${{ servicio.precio_base|floatformat:0 }}</strong></td>
              <td>{{ servicio.unidad }}</td>
              <td>
                <span class="pill {% if servicio.activo %}activo{% else %}inactivo{% endif %}">
                  {% if servicio.activo %}Activo{% else %}Inactivo{% endif %}
                </span>
              </td>
              <td>
                <div style="display: flex; gap: 4px;">
                  <button type="button" class="btn small secondary" 
                          onclick="editarServicio({{ servicio.id }})" title="Editar">
                    ‚úèÔ∏è
                  </button>
                  <button type="button" class="btn small danger" 
                          onclick="eliminarServicio({{ servicio.id }}, '{{ servicio.nombre }}')" title="Eliminar">
                    üóëÔ∏è
                  </button>
                </div>
              </td>
            </tr>
            {% empty %}
            <tr class="fila-sin-datos-original">
              <td colspan="6" style="text-align: center; padding: 40px; color: var(--gris-600);">
                {% if categoria_filtro or busqueda %}
                  No se encontraron servicios.
                {% else %}
                  No hay servicios registrados a√∫n.
                {% endif %}
                <br><br>
                <button type="button" class="btn" onclick="mostrarModal('modal-servicio')">
                  Crear Primer Servicio
                </button>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <div id="modal-ver-categorias" class="modal">
        <div class="modal-content" style="max-width: 900px;">
          <div class="modal-header">
            <h3>üè∑Ô∏è Gesti√≥n de Categor√≠as</h3>
            <button type="button" class="close" onclick="cerrarModal('modal-ver-categorias')">&times;</button>
          </div>
          <div style="margin-bottom: 16px;">
            <button type="button" class="btn" onclick="abrirNuevaCategoria()">‚ûï Nueva Categor√≠a</button>
          </div>
          <div class="filters" style="margin-bottom: 16px;">
            <div class="filter-group">
              <label>üîç Buscar Categor√≠a</label>
              <input type="text" id="filtro-categoria-nombre" placeholder="Nombre..." onkeyup="filtrarCategorias()">
            </div>
            <div class="filter-group">
                <label>&nbsp;</label>
                <button type="button" class="btn secondary small" onclick="limpiarFiltrosCategorias()">üîÑ Limpiar</button>
            </div>
          </div>
          <div style="max-height: 450px; overflow-y: auto;">
            <table id="tabla-categorias-modal">
              <thead>
                <tr>
                  <th onclick="ordenarCategorias('nombre')" style="cursor: pointer;">Nombre <span id="sort-nombre">‚áÖ</span></th>
                  <th>Descripci√≥n</th>
                  <th onclick="ordenarCategorias('orden')" style="cursor: pointer;">Orden <span id="sort-orden">‚áÖ</span></th>
                  <th onclick="ordenarCategorias('servicios')" style="cursor: pointer;">Servicios <span id="sort-servicios">‚áÖ</span></th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody id="tbody-categorias">
                {% for categoria in categorias %}
                <tr data-nombre="{{ categoria.nombre|lower }}" data-orden="{{ categoria.orden|default:0 }}" data-servicios="{{ categoria.serviciobase_set.count }}">
                  <td><strong>{{ categoria.nombre }}</strong></td>
                  <td>{{ categoria.descripcion|default:"-"|truncatewords:15 }}</td>
                  <td style="text-align: center;"><span class="pill" style="background: var(--azul-100); color: var(--azul-700);">{{ categoria.orden|default:0 }}</span></td>
                  <td style="text-align: center;"><span class="pill" style="background: var(--verde-100); color: var(--verde-600);">{{ categoria.serviciobase_set.count }}</span></td>
                  <td>
                    <div style="display: flex; gap: 4px;">
                      <button type="button" class="btn small secondary" onclick="editarCategoria({{ categoria.id }})">‚úèÔ∏è</button>
                      <button type="button" class="btn small danger" onclick="eliminarCategoria({{ categoria.id }}, '{{ categoria.nombre }}')">üóëÔ∏è</button>
                    </div>
                  </td>
                </tr>
                {% empty %}
                <tr id="row-sin-categorias"><td colspan="5" style="text-align: center;">No hay categor√≠as.</td></tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          <div id="sin-resultados-categorias" style="display: none; text-align: center; padding: 20px;">No se encontraron categor√≠as</div>
        </div>
      </div>

      <div id="modal-servicio" class="modal">
        <div class="modal-content">
          <div class="modal-header">
            <h3 id="modal-servicio-titulo">Nuevo Servicio</h3>
            <button type="button" class="close" onclick="cerrarModal('modal-servicio')">&times;</button>
          </div>
          <form id="form-servicio">
            {% csrf_token %}
            <input type="hidden" id="servicio-id" value="">
            <div class="form-group">
              <label for="servicio-categoria">Categor√≠a *</label>
              <select id="servicio-categoria" required>
                <option value="">Seleccionar categor√≠a</option>
                {% for categoria in categorias %}
                <option value="{{ categoria.id }}">{{ categoria.nombre }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="form-group"><label>Nombre *</label><input type="text" id="servicio-nombre" required></div>
            <div class="form-group"><label>Descripci√≥n *</label><textarea id="servicio-descripcion" rows="3" required></textarea></div>
            <div class="form-row">
              <div class="form-group"><label>Precio *</label><input type="number" id="servicio-precio" step="0.01" min="0" required></div>
              <div class="form-group"><label>Unidad *</label><input type="text" id="servicio-unidad" required></div>
            </div>
            <div class="form-group"><label><input type="checkbox" id="servicio-activo" checked> Servicio Activo</label></div>
            <div style="display: flex; gap: 8px; justify-content: flex-end; margin-top: 20px;">
              <button type="button" class="btn secondary" onclick="cerrarModal('modal-servicio')">Cancelar</button>
              <button type="submit" class="btn">Guardar Servicio</button>
            </div>
          </form>
        </div>
      </div>

      <div id="modal-categoria" class="modal">
        <div class="modal-content">
          <div class="modal-header">
            <h3 id="modal-categoria-titulo">Nueva Categor√≠a</h3>
            <button type="button" class="close" onclick="cerrarModal('modal-categoria')">&times;</button>
          </div>
          <form id="form-categoria">
            {% csrf_token %}
            <input type="hidden" id="categoria-id" value="">
            <div class="form-group"><label>Nombre *</label><input type="text" id="categoria-nombre" required></div>
            <div class="form-group"><label>Descripci√≥n</label><textarea id="categoria-descripcion" rows="3"></textarea></div>
            <div class="form-group"><label>Orden</label><input type="number" id="categoria-orden" min="0" value="0"></div>
            <div style="display: flex; gap: 8px; justify-content: flex-end; margin-top: 20px;">
              <button type="button" class="btn secondary" onclick="cerrarModalCategoria()">Cancelar</button>
              <button type="submit" class="btn">Guardar Categor√≠a</button>
            </div>
          </form>
        </div>
      </div>
    </main>
  </div>

<script src="{% static 'cotizaciones/js/main.js' %}"></script>
<script>
  // ==========================================
  // L√ìGICA DE SERVICIOS (CRUD y UI)
  // ==========================================

  // Inicializaci√≥n: Guardar √≠ndice original para poder resetear orden
  document.addEventListener('DOMContentLoaded', function() {
    const filas = document.querySelectorAll('#tabla-servicios tbody tr');
    filas.forEach((fila, index) => {
      fila.setAttribute('data-original-index', index);
    });

    initFiltrosRapidosServicios();
    calcularKPIs(); // Calcula los n√∫meros reales al cargar
  });

  // Calculadora precisa de KPIs basada en la tabla visual
  function calcularKPIs() {
    const filas = document.querySelectorAll('#tabla-servicios tbody tr:not(.fila-sin-datos-original)');
    
    let totalPrecio = 0;
    let conteoInactivos = 0;
    let conteoTotal = 0;
    
    // Usamos un Set para contar categor√≠as √∫nicas presentes en la tabla
    const categoriasUnicas = new Set();

    filas.forEach(fila => {
      // 1. Inactivos
      if (fila.dataset.estado === 'inactivo') {
        conteoInactivos++;
      }
      
      // 2. Categor√≠as
      if (fila.dataset.categoria) {
        categoriasUnicas.add(fila.dataset.categoria);
      }

      // 3. Promedio
      const precio = parseFloat(fila.dataset.precio) || 0;
      totalPrecio += precio;
      conteoTotal++;
    });

    // Actualizar DOM Inactivos
    const elInactivos = document.getElementById('count-inactivos');
    if(elInactivos) elInactivos.textContent = conteoInactivos;

    // Actualizar DOM Categor√≠as (Correcci√≥n solicitada)
    const elCategorias = document.getElementById('count-categorias');
    if(elCategorias && categoriasUnicas.size > 0) {
        // Si hay datos en la tabla, usamos el conteo real de la tabla
        elCategorias.textContent = categoriasUnicas.size; 
    }

    // Actualizar DOM Promedio
    const elPromedio = document.getElementById('valor-promedio-display');
    if(elPromedio) {
      const promedio = conteoTotal > 0 ? (totalPrecio / conteoTotal) : 0;
      elPromedio.textContent = '$' + Math.round(promedio).toLocaleString('es-ES');
    }
  }

  // Restaurar orden original de la tabla (deshacer ordenamiento por precio)
  function restaurarOrdenOriginal() {
    const tbody = document.querySelector('#tabla-servicios tbody');
    const filas = Array.from(tbody.querySelectorAll('tr'));
    
    // Separar filas de datos de mensajes
    const filasDatos = filas.filter(f => f.hasAttribute('data-original-index'));
    const otrasFilas = filas.filter(f => !f.hasAttribute('data-original-index'));

    // Ordenar por √≠ndice original ascendente
    filasDatos.sort((a, b) => {
      const idxA = parseInt(a.getAttribute('data-original-index'));
      const idxB = parseInt(b.getAttribute('data-original-index'));
      return idxA - idxB;
    });

    filasDatos.forEach(fila => tbody.appendChild(fila));
    otrasFilas.forEach(fila => tbody.appendChild(fila));
  }

  // Funci√≥n maestra de Reset (Limpiar todo)
  function limpiarTodoYResetear() {
    // 1. Limpiar inputs
    document.getElementById('busqueda').value = '';
    document.getElementById('categoria').value = '';
    document.getElementById('filtro-estado').value = '';
    
    // 2. Quitar estilos activos de las tarjetas
    document.querySelectorAll('.cards .card').forEach(card => {
      card.classList.remove('active');
    });

    // 3. Restaurar orden original de filas
    restaurarOrdenOriginal();

    // 4. Aplicar filtros (que ahora mostrar√° todo porque los inputs est√°n vac√≠os)
    aplicarFiltros(); 
  }

  // Ordenar por precio mayor a menor
  function ordenarPorPrecioMayorAMenor() {
    const tbody = document.querySelector('#tabla-servicios tbody');
    const filas = Array.from(tbody.querySelectorAll('tr'));
    
    const filasDatos = filas.filter(f => f.hasAttribute('data-precio'));
    const otrasFilas = filas.filter(f => !f.hasAttribute('data-precio'));

    filasDatos.sort((a, b) => {
      const precioA = parseFloat(a.dataset.precio) || 0;
      const precioB = parseFloat(b.dataset.precio) || 0;
      return precioB - precioA;
    });

    filasDatos.forEach(fila => tbody.appendChild(fila));
    otrasFilas.forEach(fila => tbody.appendChild(fila));
  }

  // ===== L√ìGICA DE TARJETAS INTELIGENTES (TOGGLE) =====
  function initFiltrosRapidosServicios() {
    const kpiTotal = document.querySelector('#kpi-total-servicios');
    const kpiCategorias = document.querySelector('#kpi-categorias');
    const kpiInactivos = document.querySelector('#kpi-inactivos');
    const kpiPromedio = document.querySelector('#kpi-promedio');
    const selectEstado = document.querySelector('#filtro-estado');
    
    function limpiarEstilosTarjetas() {
      document.querySelectorAll('.cards .card').forEach(card => card.classList.remove('active'));
    }
    
    // 1. Total Servicios: Siempre resetea todo
    if (kpiTotal) {
      kpiTotal.addEventListener('click', function(e) {
        createRipple(e, this);
        limpiarTodoYResetear();
        this.classList.add('active'); // Opcional: dejar marcado que estamos viendo "todo"
      });
    }

    // 2. Promedio: Ordena por precio (Toggle)
    if (kpiPromedio) {
      kpiPromedio.addEventListener('click', function(e) {
        createRipple(e, this);
        
        // Si ya estaba activo, RESETEAMOS (Toggle Off)
        if (this.classList.contains('active')) {
            limpiarTodoYResetear();
            return;
        }

        // Si no, activamos y ordenamos
        limpiarEstilosTarjetas();
        this.classList.add('active');
        ordenarPorPrecioMayorAMenor();
      });
    }
    
    // 3. Inactivos: Filtra inactivos (Toggle)
    if (kpiInactivos) {
      kpiInactivos.addEventListener('click', function(e) {
        createRipple(e, this);
        
        // Si ya estaba activo, RESETEAMOS (Toggle Off)
        if (this.classList.contains('active')) {
            limpiarTodoYResetear();
            return;
        }

        // Si no, activamos y filtramos
        limpiarEstilosTarjetas();
        this.classList.add('active');
        
        // Limpiamos otros filtros primero para asegurar pureza
        document.getElementById('busqueda').value = '';
        document.getElementById('categoria').value = '';
        if (selectEstado) selectEstado.value = 'inactivo';
        
        aplicarFiltros();
      });
    }

    // 4. Categor√≠as: Abre modal (sin cambios l√≥gicos)
    if (kpiCategorias) {
      kpiCategorias.addEventListener('click', function(e) {
        createRipple(e, this);
        setTimeout(() => mostrarModal('modal-ver-categorias'), 100);
      });
    }
  }

  // Funci√≥n est√°ndar de filtrado (Actualizada para manejar estado visual)
  function aplicarFiltros() {
    const busqueda = document.getElementById('busqueda').value.toLowerCase();
    const categoria = document.getElementById('categoria').value;
    const estado = document.getElementById('filtro-estado').value;
    
    const filas = document.querySelectorAll('#tabla-servicios tbody tr');
    let visibles = 0;
    
    filas.forEach(fila => {
      // Ignorar filas de mensaje si existen (se manejan abajo)
      if (!fila.hasAttribute('data-categoria')) return;
      
      const textoFila = fila.textContent.toLowerCase();
      const categoriaFila = fila.dataset.categoria;
      const estadoFila = fila.dataset.estado;
      
      let mostrar = true;
      if (busqueda && !textoFila.includes(busqueda)) mostrar = false;
      if (categoria && categoriaFila !== categoria) mostrar = false;
      if (estado && estadoFila !== estado) mostrar = false;
      
      fila.style.display = mostrar ? '' : 'none';
      if (mostrar) visibles++;
    });
    
    actualizarMensajeSinResultados(visibles);
  }

  // Mensaje de Sin Resultados
  function actualizarMensajeSinResultados(visibles) {
    const tbody = document.querySelector('#tabla-servicios tbody');
    let filaMensaje = tbody.querySelector('.fila-sin-resultados');
    const filaOriginalSinDatos = tbody.querySelector('.fila-sin-datos-original');
    
    // Ocultar la fila original de "sin datos" si existe y estamos filtrando
    if (filaOriginalSinDatos) filaOriginalSinDatos.style.display = 'none';

    if (visibles === 0) {
      if (!filaMensaje) {
        filaMensaje = document.createElement('tr');
        filaMensaje.className = 'fila-sin-resultados';
        filaMensaje.innerHTML = `
          <td colspan="6" style="text-align: center; padding: 40px; color: var(--gris-600);">
            No se encontraron servicios con estos filtros.
            <br><br>
            <button type="button" class="btn secondary" onclick="limpiarTodoYResetear()">Limpiar Filtros</button>
          </td>`;
        tbody.appendChild(filaMensaje);
      }
    } else if (filaMensaje) {
      filaMensaje.remove();
    }
  }

  // Funciones CRUD del servidor (EDITAR / GUARDAR / ELIMINAR)
  async function editarServicio(servicioId) {
    try {
      const response = await fetch(`/cotizaciones/servicio/${servicioId}/`);
      const result = await response.json();
      if (result.success) {
        document.getElementById('modal-servicio-titulo').textContent = 'Editar Servicio';
        document.getElementById('servicio-id').value = servicioId;
        document.getElementById('servicio-categoria').value = result.servicio.categoria_id;
        document.getElementById('servicio-nombre').value = result.servicio.nombre;
        document.getElementById('servicio-descripcion').value = result.servicio.descripcion;
        document.getElementById('servicio-precio').value = result.servicio.precio_base;
        document.getElementById('servicio-unidad').value = result.servicio.unidad;
        document.getElementById('servicio-activo').checked = result.servicio.activo;
        mostrarModal('modal-servicio');
      } else { alert('Error: ' + result.error); }
    } catch (error) { console.error(error); alert('Error al cargar servicio'); }
  }

  function cerrarModalServicio() {
    document.getElementById('modal-servicio-titulo').textContent = 'Nuevo Servicio';
    document.getElementById('servicio-id').value = '';
    document.getElementById('form-servicio').reset();
    document.getElementById('servicio-activo').checked = true;
    document.getElementById('modal-servicio').classList.remove('show');
  }

  document.getElementById('form-servicio').addEventListener('submit', async function(e) {
    e.preventDefault();
    const formData = {
      categoria_id: document.getElementById('servicio-categoria').value,
      nombre: document.getElementById('servicio-nombre').value,
      descripcion: document.getElementById('servicio-descripcion').value,
      precio_base: document.getElementById('servicio-precio').value,
      unidad: document.getElementById('servicio-unidad').value,
      es_parametrizable: false,
      activo: document.getElementById('servicio-activo').checked
    };
    const servicioId = document.getElementById('servicio-id').value;
    const isEditing = servicioId !== '';
    try {
      const url = isEditing ? `/cotizaciones/servicio/${servicioId}/editar/` : '/cotizaciones/servicio/crear/';
      const method = isEditing ? 'PUT' : 'POST';
      const response = await fetch(url, {
        method: method,
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCSRFToken() },
        body: JSON.stringify(formData)
      });
      const result = await response.json();
      if (result.success) { alert(result.message); cerrarModalServicio(); location.reload(); }
      else { alert('Error: ' + result.error); }
    } catch (error) { console.error(error); alert('Error al guardar'); }
  });

  // CRUD Categor√≠as
  document.getElementById('form-categoria').addEventListener('submit', async function(e) {
    e.preventDefault();
    const categoriaId = document.getElementById('categoria-id').value;
    const isEditing = categoriaId !== '';
    const formData = {
      nombre: document.getElementById('categoria-nombre').value,
      descripcion: document.getElementById('categoria-descripcion').value,
      orden: document.getElementById('categoria-orden').value
    };
    try {
      const url = isEditing ? `/cotizaciones/categoria-servicio/${categoriaId}/editar/` : '/cotizaciones/categoria-servicio/crear/';
      const method = isEditing ? 'PUT' : 'POST';
      const response = await fetch(url, {
        method: method,
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCSRFToken() },
        body: JSON.stringify(formData)
      });
      const result = await response.json();
      if (result.success) { alert(result.message); cerrarModal('modal-categoria'); location.reload(); }
      else { alert('Error: ' + result.error); }
    } catch (error) { console.error(error); alert('Error al guardar categor√≠a'); }
  });

  async function editarCategoria(id) {
    try {
      const res = await fetch(`/cotizaciones/categoria-servicio/${id}/`);
      const data = await res.json();
      if (data.success) {
        document.getElementById('modal-categoria-titulo').textContent = 'Editar Categor√≠a';
        document.getElementById('categoria-id').value = id;
        document.getElementById('categoria-nombre').value = data.categoria.nombre;
        document.getElementById('categoria-descripcion').value = data.categoria.descripcion || '';
        document.getElementById('categoria-orden').value = data.categoria.orden || 0;
        cerrarModal('modal-ver-categorias');
        mostrarModal('modal-categoria');
      } else alert(data.error);
    } catch (e) { alert('Error de conexi√≥n'); }
  }

  async function eliminarCategoria(id, nombre) {
    if (!confirm(`¬øEliminar categor√≠a "${nombre}"?`)) return;
    try {
      const res = await fetch(`/cotizaciones/categoria-servicio/${id}/eliminar/`, { method: 'DELETE', headers: {'X-CSRFToken': getCSRFToken()} });
      const data = await res.json();
      if (data.success) location.reload(); else alert(data.error);
    } catch (e) { alert('Error al eliminar'); }
  }

  function cerrarModalCategoria() {
    document.getElementById('modal-categoria-titulo').textContent = 'Nueva Categor√≠a';
    document.getElementById('categoria-id').value = '';
    document.getElementById('form-categoria').reset();
    cerrarModal('modal-categoria');
    mostrarModal('modal-ver-categorias');
  }

  function abrirNuevaCategoria() { cerrarModal('modal-ver-categorias'); mostrarModal('modal-categoria'); }

  // Utils
  function createRipple(event, element) {
    const ripple = document.createElement('span');
    const rect = element.getBoundingClientRect();
    const size = Math.max(rect.width, rect.height);
    const x = event.clientX - rect.left - size / 2;
    const y = event.clientY - rect.top - size / 2;
    ripple.style.width = ripple.style.height = size + 'px';
    ripple.style.left = x + 'px';
    ripple.style.top = y + 'px';
    ripple.classList.add('ripple-effect');
    element.appendChild(ripple);
    setTimeout(() => ripple.remove(), 600);
  }
  
  function toggleExportMenu(menuId) {
    const menu = document.getElementById(menuId);
    document.querySelectorAll('.export-menu').forEach(m => { if(m.id!==menuId) m.style.display='none'; });
    menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
  }
  document.addEventListener('click', e => { if(!e.target.closest('.dropdown-export')) document.querySelectorAll('.export-menu').forEach(m=>m.style.display='none'); });
  document.getElementById('busqueda').addEventListener('input', aplicarFiltros);
  document.getElementById('categoria').addEventListener('change', aplicarFiltros);
  document.getElementById('filtro-estado').addEventListener('change', aplicarFiltros);
  document.querySelectorAll('.modal').forEach(m => m.addEventListener('click', e => { if(e.target===m) e.stopPropagation(); }));

  // Funciones de filtro modal categor√≠as
  function filtrarCategorias() {
    const q = document.getElementById('filtro-categoria-nombre').value.toLowerCase();
    const rows = document.querySelectorAll('#tbody-categorias tr:not(#row-sin-categorias)');
    let v = 0;
    rows.forEach(r => { const n = r.dataset.nombre || ''; const show = n.includes(q); r.style.display=show?'':'none'; if(show)v++; });
    document.getElementById('sin-resultados-categorias').style.display = (v===0 && rows.length>0) ? 'block' : 'none';
    document.getElementById('tbody-categorias').style.display = (v===0 && rows.length>0) ? 'none' : '';
  }
  function limpiarFiltrosCategorias(){ document.getElementById('filtro-categoria-nombre').value=''; filtrarCategorias(); }
  let ordCat={col:null,asc:true};
  function ordenarCategorias(col){
    const tbody=document.getElementById('tbody-categorias');
    const rows=Array.from(tbody.querySelectorAll('tr:not(#row-sin-categorias)'));
    if(ordCat.col===col) ordCat.asc=!ordCat.asc; else { ordCat.col=col; ordCat.asc=true; }
    rows.sort((a,b)=>{
        let vA,vB;
        if(col==='nombre'){ vA=a.dataset.nombre||''; vB=b.dataset.nombre||''; }
        else if(col==='orden'){ vA=parseInt(a.dataset.orden)||0; vB=parseInt(b.dataset.orden)||0; }
        else if(col==='servicios'){ vA=parseInt(a.dataset.servicios)||0; vB=parseInt(b.dataset.servicios)||0; }
        if(vA<vB)return ordCat.asc?-1:1; if(vA>vB)return ordCat.asc?1:-1; return 0;
    });
    rows.forEach(r=>tbody.appendChild(r));
    document.querySelectorAll('#tabla-categorias-modal thead span').forEach(s=>s.textContent='‚áÖ');
    const ico=document.getElementById(`sort-${col}`); if(ico) ico.textContent=ordCat.asc?'‚ñ≤':'‚ñº';
  }
</script>
</body>
</html>