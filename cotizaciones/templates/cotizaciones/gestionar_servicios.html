{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Gestionar Servicios - Sistema de Cotizaciones</title>
  <link rel="stylesheet" href="{% static 'css/main.css' %}">
</head>
<body>
  {% include 'notificaciones/helmet.html' %}

    <main>

      <!-- Estad√≠sticas -->
      <div class="cards">
        <div class="card" id="kpi-total-servicios">
          <h4>Total Servicios</h4>
          <div class="kpi">{{ servicios|length }}</div>
          <div class="muted">Disponibles</div>
        </div>
        <div class="card" id="kpi-parametrizables">
          <h4>Parametrizables</h4>
          <div class="kpi">{{ servicios_parametrizables|default:0 }}</div>
          <div class="muted">Con configuraci√≥n</div>
        </div>
        <div class="card" id="kpi-categorias">
          <h4>Categor√≠as</h4>
          <div class="kpi">{{ categorias|length }}</div>
          <div class="muted">Organizadas</div>
        </div>
        <div class="card" id="kpi-activos">
          <h4>Activos</h4>
          <div class="kpi">{{ servicios_activos|default:0 }}</div>
          <div class="muted">En uso</div>
        </div>
      </div>

      <!-- Actions -->
      <div class="actions">
        <div class="actions-left">
          <h1 style="margin: 0; color: var(--azul-700);">Cat√°logo de Servicios</h1>
        </div>
        <div class="actions-right">
          <div class="dropdown-export" style="position: relative; display: inline-block;">
            <button type="button" class="btn secondary" onclick="toggleExportMenu('export-servicios')">
              üì• Exportar
            </button>
            <div id="export-servicios" class="export-menu" style="display: none;">
              <a href="{% url 'cotizaciones:exportar_servicios' %}?formato=excel{% if categoria_filtro %}&categoria={{ categoria_filtro }}{% endif %}">
                üìä Exportar a Excel
              </a>
              <a href="{% url 'cotizaciones:exportar_servicios' %}?formato=csv{% if categoria_filtro %}&categoria={{ categoria_filtro }}{% endif %}">
                üìÑ Exportar a CSV
              </a>
            </div>
          </div>
          <button type="button" class="btn" onclick="mostrarModal('modal-servicio')">
            ‚ûï Nuevo Servicio
          </button>
          <button type="button" class="btn secondary" onclick="mostrarModal('modal-ver-categorias')">
            üè∑Ô∏è Categor√≠as
          </button>
        </div>
      </div>

      <!-- Filtros -->
      <div class="filters">
        <div class="filter-group">
          <label for="categoria">Categor√≠a</label>
          <select id="categoria" name="categoria">
            <option value="">Todas las categor√≠as</option>
            {% for categoria in categorias %}
              <option value="{{ categoria.id }}" 
                      {% if categoria.id|stringformat:"s" == categoria_filtro %}selected{% endif %}>
                {{ categoria.nombre }}
              </option>
            {% endfor %}
          </select>
        </div>
        
        <div class="filter-group">
          <label for="filtro-parametrizable">Parametrizable</label>
          <select id="filtro-parametrizable">
            <option value="">Todos</option>
            <option value="si">S√≠</option>
            <option value="no">No</option>
          </select>
        </div>
        
        <div class="filter-group">
          <label for="filtro-estado">Estado</label>
          <select id="filtro-estado">
            <option value="">Todos</option>
            <option value="activo">Activo</option>
            <option value="inactivo">Inactivo</option>
          </select>
        </div>
        
        <div class="filter-group">
          <label for="busqueda">Buscar Servicio</label>
          <input type="text" id="busqueda" name="busqueda" value="{{ busqueda }}" 
                placeholder="Nombre, descripci√≥n...">
        </div>
        
        <div class="filter-group" style="align-self: end;">
          <button type="button" class="btn secondary" onclick="limpiarFiltros()">
            üóëÔ∏è Limpiar
          </button>
        </div>
      </div>

      <!-- Tabla de Servicios -->
      <div class="table-wrap">
        <table id="tabla-servicios">
          <thead>
            <tr>
              <th>Servicio</th>
              <th>Categor√≠a</th>
              <th>Precio Base</th>
              <th>Unidad</th>
              <th>Parametrizable</th>
              <th>Estado</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            {% for servicio in servicios %}
            <tr data-parametrizable="{% if servicio.es_parametrizable %}si{% else %}no{% endif %}" 
                data-estado="{% if servicio.activo %}activo{% else %}inactivo{% endif %}"
                data-categoria="{{ servicio.categoria.id }}">
              <td>
                <strong>{{ servicio.nombre }}</strong>
                <div style="font-size: 0.85rem; color: var(--gris-600); margin-top: 4px;">
                  {{ servicio.descripcion|truncatewords:15 }}
                </div>
              </td>
              <td>
                <span class="pill enviada">{{ servicio.categoria.nombre }}</span>
              </td>
              <td><strong>${{ servicio.precio_base|floatformat:0 }}</strong></td>
              <td>{{ servicio.unidad }}</td>
              <td>
                {% if servicio.es_parametrizable %}
                  <span class="pill aprobada">S√≠</span>
                {% else %}
                  <span class="pill borrador">No</span>
                {% endif %}
              </td>
              <td>
                <span class="pill {% if servicio.activo %}activo{% else %}inactivo{% endif %}">
                  {% if servicio.activo %}Activo{% else %}Inactivo{% endif %}
                </span>
              </td>
              <td>
                <div style="display: flex; gap: 4px;">
                  <button type="button" class="btn small secondary" 
                          onclick="verParametros({{ servicio.id }})" title="Ver par√°metros">
                    ‚öôÔ∏è
                  </button>
                  <button type="button" class="btn small secondary" 
                          onclick="editarServicio({{ servicio.id }})" title="Editar">
                    ‚úèÔ∏è
                  </button>
                  <button type="button" class="btn small danger" 
                          onclick="eliminarServicio({{ servicio.id }}, '{{ servicio.nombre }}')" title="Eliminar">
                    üóëÔ∏è
                  </button>
                </div>
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="7" style="text-align: center; padding: 40px; color: var(--gris-600);">
                {% if categoria_filtro or busqueda %}
                  No se encontraron servicios que coincidan con los filtros aplicados.
                {% else %}
                  No hay servicios registrados a√∫n.
                {% endif %}
                <br><br>
                <button type="button" class="btn" onclick="mostrarModal('modal-servicio')">
                  Crear Primer Servicio
                </button>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <!-- Modal Ver Categor√≠as -->
      <div id="modal-ver-categorias" class="modal">
        <div class="modal-content" style="max-width: 900px;">
          <div class="modal-header">
            <h3>üè∑Ô∏è Gesti√≥n de Categor√≠as</h3>
            <button type="button" class="close" onclick="cerrarModal('modal-ver-categorias')">&times;</button>
          </div>
          
          <!-- Bot√≥n Nueva Categor√≠a -->
          <div style="margin-bottom: 16px;">
            <button type="button" class="btn" onclick="abrirNuevaCategoria()">
              ‚ûï Nueva Categor√≠a
            </button>
          </div>
          
          <!-- Filtros de b√∫squeda -->
          <div class="filters" style="margin-bottom: 16px;">
            <div class="filter-group">
              <label for="filtro-categoria-nombre">üîç Buscar Categor√≠a</label>
              <input type="text" id="filtro-categoria-nombre" 
                     placeholder="Nombre de la categor√≠a..."
                     onkeyup="filtrarCategorias()">
            </div>
            
            <div class="filter-group">
              <label>&nbsp;</label>
              <button type="button" class="btn secondary small" onclick="limpiarFiltrosCategorias()">
                üîÑ Limpiar
              </button>
            </div>
          </div>
          
          <!-- Tabla de Categor√≠as -->
          <div style="max-height: 450px; overflow-y: auto;">
            <table id="tabla-categorias-modal">
              <thead>
                <tr>
                  <th onclick="ordenarCategorias('nombre')" style="cursor: pointer;">
                    Nombre <span id="sort-nombre">‚áÖ</span>
                  </th>
                  <th>Descripci√≥n</th>
                  <th onclick="ordenarCategorias('orden')" style="cursor: pointer;">
                    Orden <span id="sort-orden">‚áÖ</span>
                  </th>
                  <th onclick="ordenarCategorias('servicios')" style="cursor: pointer;">
                    Servicios <span id="sort-servicios">‚áÖ</span>
                  </th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody id="tbody-categorias">
                {% for categoria in categorias %}
                <tr data-nombre="{{ categoria.nombre|lower }}" 
                    data-orden="{{ categoria.orden|default:0 }}"
                    data-servicios="{{ categoria.serviciobase_set.count }}">
                  <td>
                    <strong>{{ categoria.nombre }}</strong>
                  </td>
                  <td>
                    {{ categoria.descripcion|default:"-"|truncatewords:15 }}
                  </td>
                  <td style="text-align: center;">
                    <span class="pill" style="background: var(--azul-100); color: var(--azul-700); border-color: var(--azul-300);">
                      {{ categoria.orden|default:0 }}
                    </span>
                  </td>
                  <td style="text-align: center;">
                    <span class="pill" style="background: var(--verde-100); color: var(--verde-600); border-color: var(--verde-600);">
                      {{ categoria.serviciobase_set.count }} servicio{{ categoria.serviciobase_set.count|pluralize }}
                    </span>
                  </td>
                  <td>
                    <div style="display: flex; gap: 4px;">
                      <button type="button" class="btn small secondary" 
                              onclick="editarCategoria({{ categoria.id }})" title="Editar">
                        ‚úèÔ∏è
                      </button>
                      <button type="button" class="btn small danger" 
                              onclick="eliminarCategoria({{ categoria.id }}, '{{ categoria.nombre }}')" title="Eliminar">
                        üóëÔ∏è
                      </button>
                    </div>
                  </td>
                </tr>
                {% empty %}
                <tr id="row-sin-categorias">
                  <td colspan="5" style="text-align: center; padding: 40px; color: var(--gris-600);">
                    No hay categor√≠as registradas a√∫n.
                    <br><br>
                    <button type="button" class="btn" onclick="abrirNuevaCategoria()">
                      Crear Primera Categor√≠a
                    </button>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          
          <!-- Mensaje cuando no hay resultados del filtro -->
          <div id="sin-resultados-categorias" style="display: none; text-align: center; padding: 40px; color: var(--gris-600);">
            <div style="font-size: 3rem; margin-bottom: 12px;">üîç</div>
            <h4 style="margin: 0 0 8px; color: var(--azul-700);">No se encontraron categor√≠as</h4>
            <p style="margin: 0;">Intenta ajustar la b√∫squeda</p>
          </div>
          
          <!-- Footer con resumen y bot√≥n cerrar -->
          <div style="display: flex; gap: 8px; justify-content: space-between; align-items: center; margin-top: 20px; padding-top: 16px; border-top: 1px solid var(--gris-300);">
            <div style="color: var(--gris-600);">
              <strong>Total categor√≠as:</strong> {{ categorias|length }}
            </div>
            <button type="button" class="btn secondary" onclick="cerrarModal('modal-ver-categorias')">
              Cerrar
            </button>
          </div>
        </div>
      </div>

      <!-- Modal Nuevo Servicio -->
      <div id="modal-servicio" class="modal">
        <div class="modal-content">
          <div class="modal-header">
            <h3 id="modal-servicio-titulo">Nuevo Servicio</h3>
            <button type="button" class="close" onclick="cerrarModal('modal-servicio')">&times;</button>
          </div>
          
          <form id="form-servicio">
            {% csrf_token %}
            <input type="hidden" id="servicio-id" value="">
            
            <div class="form-group">
              <label for="servicio-categoria">Categor√≠a *</label>
              <select id="servicio-categoria" required>
                <option value="">Seleccionar categor√≠a</option>
                {% for categoria in categorias %}
                <option value="{{ categoria.id }}">{{ categoria.nombre }}</option>
                {% endfor %}
              </select>
            </div>
            
            <div class="form-group">
              <label for="servicio-nombre">Nombre del Servicio *</label>
              <input type="text" id="servicio-nombre" required 
                    placeholder="Ej: Instalaci√≥n Bomba Sumergible">
            </div>
            
            <div class="form-group">
              <label for="servicio-descripcion">Descripci√≥n *</label>
              <textarea id="servicio-descripcion" rows="3" required
                        placeholder="Descripci√≥n detallada del servicio"></textarea>
            </div>
            
            <div class="form-row">
              <div class="form-group">
                <label for="servicio-precio">Precio Base *</label>
                <input type="number" id="servicio-precio" step="0.01" min="0" required
                      placeholder="150000">
              </div>
              <div class="form-group">
                <label for="servicio-unidad">Unidad *</label>
                <input type="text" id="servicio-unidad" required
                      placeholder="UND, MT, KG, etc.">
              </div>
            </div>
            
            <div class="form-group">
              <label>
                <input type="checkbox" id="servicio-parametrizable"> 
                ¬øEs parametrizable?
              </label>
              <small style="color: var(--gris-600);">
                Permite configurar par√°metros como potencia, voltaje, etc.
              </small>
            </div>
            
            <div class="form-group">
              <label>
                <input type="checkbox" id="servicio-activo" checked> 
                Servicio Activo
              </label>
            </div>
            
            <div style="display: flex; gap: 8px; justify-content: flex-end; margin-top: 20px;">
              <button type="button" class="btn secondary" onclick="cerrarModal('modal-servicio')">
                Cancelar
              </button>
              <button type="submit" class="btn">
                Guardar Servicio
              </button>
            </div>
          </form>
        </div>
      </div>

      <!-- Modal Ver Categor√≠as -->
      <div id="modal-ver-categorias" class="modal">
        <div class="modal-content" style="max-width: 900px;">
          <div class="modal-header">
            <h3>üè∑Ô∏è Gesti√≥n de Categor√≠as</h3>
            <button type="button" class="close" onclick="cerrarModal('modal-ver-categorias')">&times;</button>
          </div>
          
          <!-- Bot√≥n Nueva Categor√≠a -->
          <div style="margin-bottom: 16px;">
            <button type="button" class="btn" onclick="abrirNuevaCategoria()">
              ‚ûï Nueva Categor√≠a
            </button>
          </div>
          
          <!-- Filtros de b√∫squeda -->
          <div class="filters" style="margin-bottom: 16px;">
            <div class="filter-group">
              <label for="filtro-categoria-nombre">üîç Buscar Categor√≠a</label>
              <input type="text" id="filtro-categoria-nombre" 
                     placeholder="Nombre de la categor√≠a..."
                     onkeyup="filtrarCategorias()">
            </div>
            
            <div class="filter-group">
              <label>&nbsp;</label>
              <button type="button" class="btn secondary small" onclick="limpiarFiltrosCategorias()">
                üîÑ Limpiar
              </button>
            </div>
          </div>
          
          <!-- Tabla de Categor√≠as -->
          <div style="max-height: 450px; overflow-y: auto;">
            <table id="tabla-categorias-modal">
              <thead>
                <tr>
                  <th onclick="ordenarCategorias('nombre')" style="cursor: pointer;">
                    Nombre <span id="sort-nombre">‚áÖ</span>
                  </th>
                  <th>Descripci√≥n</th>
                  <th onclick="ordenarCategorias('orden')" style="cursor: pointer;">
                    Orden <span id="sort-orden">‚áÖ</span>
                  </th>
                  <th onclick="ordenarCategorias('servicios')" style="cursor: pointer;">
                    Servicios <span id="sort-servicios">‚áÖ</span>
                  </th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody id="tbody-categorias">
                {% for categoria in categorias %}
                <tr data-nombre="{{ categoria.nombre|lower }}" 
                    data-orden="{{ categoria.orden|default:0 }}"
                    data-servicios="{{ categoria.servicio_set.count }}">
                  <td>
                    <strong>{{ categoria.nombre }}</strong>
                  </td>
                  <td>
                    {{ categoria.descripcion|default:"-"|truncatewords:15 }}
                  </td>
                  <td style="text-align: center;">
                    <span class="pill" style="background: var(--azul-100); color: var(--azul-700); border-color: var(--azul-300);">
                      {{ categoria.orden|default:0 }}
                    </span>
                  </td>
                  <td style="text-align: center;">
                    <span class="pill" style="background: var(--verde-100); color: var(--verde-600); border-color: var(--verde-600);">
                      {{ categoria.servicio_set.count }} servicio{{ categoria.servicio_set.count|pluralize }}
                    </span>
                  </td>
                  <td>
                    <div style="display: flex; gap: 4px;">
                      <button type="button" class="btn small secondary" 
                              onclick="editarCategoria({{ categoria.id }})" title="Editar">
                        ‚úèÔ∏è
                      </button>
                      <button type="button" class="btn small danger" 
                              onclick="eliminarCategoria({{ categoria.id }}, '{{ categoria.nombre }}')" title="Eliminar">
                        üóëÔ∏è
                      </button>
                    </div>
                  </td>
                </tr>
                {% empty %}
                <tr id="row-sin-categorias">
                  <td colspan="5" style="text-align: center; padding: 40px; color: var(--gris-600);">
                    No hay categor√≠as registradas a√∫n.
                    <br><br>
                    <button type="button" class="btn" onclick="abrirNuevaCategoria()">
                      Crear Primera Categor√≠a
                    </button>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          
          <!-- Mensaje cuando no hay resultados del filtro -->
          <div id="sin-resultados-categorias" style="display: none; text-align: center; padding: 40px; color: var(--gris-600);">
            <div style="font-size: 3rem; margin-bottom: 12px;">üîç</div>
            <h4 style="margin: 0 0 8px; color: var(--azul-700);">No se encontraron categor√≠as</h4>
            <p style="margin: 0;">Intenta ajustar la b√∫squeda</p>
          </div>
          
          <!-- Footer con resumen y bot√≥n cerrar -->
          <div style="display: flex; gap: 8px; justify-content: space-between; align-items: center; margin-top: 20px;">
            <div style="color: var(--gris-600);">
              <strong>Total categor√≠as:</strong> {{ categorias|length }}
            </div>
            <button type="button" class="btn secondary" onclick="cerrarModal('modal-ver-categorias')">
              Cerrar
            </button>
          </div>
        </div>
      </div>

      <!-- Modal Nueva/Editar Categor√≠a -->
      <div id="modal-categoria" class="modal">
        <div class="modal-content">
          <div class="modal-header">
            <h3 id="modal-categoria-titulo">Nueva Categor√≠a</h3>
            <button type="button" class="close" onclick="cerrarModal('modal-categoria')">&times;</button>
          </div>
          
          <form id="form-categoria">
            {% csrf_token %}
            <input type="hidden" id="categoria-id" value="">
            
            <div class="form-group">
              <label for="categoria-nombre">Nombre de la Categor√≠a *</label>
              <input type="text" id="categoria-nombre" required 
                    placeholder="Ej: Equipo Sumergible, Sistema El√©ctrico">
            </div>
            
            <div class="form-group">
              <label for="categoria-descripcion">Descripci√≥n</label>
              <textarea id="categoria-descripcion" rows="3"
                        placeholder="Descripci√≥n de la categor√≠a (opcional)"></textarea>
            </div>
            
            <div class="form-group">
              <label for="categoria-orden">Orden de Visualizaci√≥n</label>
              <input type="number" id="categoria-orden" min="0" value="0"
                    placeholder="0 = Primera, 1 = Segunda, etc.">
            </div>
            
            <div style="display: flex; gap: 8px; justify-content: flex-end; margin-top: 20px;">
              <button type="button" class="btn secondary" onclick="cerrarModalCategoria()">
                Cancelar
              </button>
              <button type="submit" class="btn">
                Guardar Categor√≠a
              </button>
            </div>
          </form>
        </div>
      </div>

      <!-- Modal Ver Par√°metros -->
      <div id="modal-parametros" class="modal">
        <div class="modal-content">
          <div class="modal-header">
            <h3>Par√°metros del Servicio</h3>
            <button type="button" class="close" onclick="cerrarModal('modal-parametros')">&times;</button>
          </div>
          
          <div id="parametros-contenido">
            <!-- Contenido din√°mico de par√°metros -->
          </div>
          
          <div style="display: flex; gap: 8px; justify-content: flex-end; margin-top: 20px;">
            <button type="button" class="btn secondary" onclick="cerrarModal('modal-parametros')">
              Cerrar
            </button>
            <button type="button" class="btn" onclick="editarParametros()">
              Editar Par√°metros
            </button>
          </div>
        </div>
      </div>
    </main>
  </div>


<script src="{% static 'cotizaciones/js/main.js' %}"></script>
<script>
  // Funciones espec√≠ficas para gesti√≥n de servicios

  async function editarServicio(servicioId) {
    try {
      const response = await fetch(`/cotizaciones/servicio/${servicioId}/`);
      const result = await response.json();
      
      if (result.success) {
        document.getElementById('modal-servicio-titulo').textContent = 'Editar Servicio';
        document.getElementById('servicio-id').value = servicioId;
        
        document.getElementById('servicio-categoria').value = result.servicio.categoria_id;
        document.getElementById('servicio-nombre').value = result.servicio.nombre;
        document.getElementById('servicio-descripcion').value = result.servicio.descripcion;
        document.getElementById('servicio-precio').value = result.servicio.precio_base;
        document.getElementById('servicio-unidad').value = result.servicio.unidad;
        document.getElementById('servicio-parametrizable').checked = result.servicio.es_parametrizable;
        document.getElementById('servicio-activo').checked = result.servicio.activo;
        
        mostrarModal('modal-servicio');
      } else {
        alert('Error al cargar los datos del servicio: ' + result.error);
      }
    } catch (error) {
      console.error('Error cargando servicio:', error);
      alert('Error al cargar los datos del servicio');
    }
  }
  
  async function verParametros(servicioId) {
    try {
      const contenido = document.getElementById('parametros-contenido');
      contenido.innerHTML = `
        <div style="text-align: center; padding: 20px;">
          <p>Cargando par√°metros del servicio...</p>
        </div>
      `;
      
      mostrarModal('modal-parametros');
      
      const response = await fetch(`/cotizaciones/servicio/${servicioId}/parametros/`);
      const result = await response.json();
      
      if (result.success) {
        if (result.parametros.length === 0) {
          contenido.innerHTML = `
            <div style="text-align: center; padding: 20px; color: var(--gris-600);">
              <p>Este servicio no tiene par√°metros configurados.</p>
              <p>Los par√°metros permiten personalizar el servicio con opciones como potencia, voltaje, dimensiones, etc.</p>
              <br>
              <button type="button" class="btn" onclick="abrirGestionParametros(${servicioId})">
                Agregar Par√°metros
              </button>
            </div>
          `;
        } else {
          let html = `
            <div class="table-wrap">
              <table>
                <thead>
                  <tr>
                    <th>Par√°metro</th>
                    <th>Tipo</th>
                    <th>Requerido</th>
                    <th>Valor por Defecto</th>
                    <th>Opciones</th>
                  </tr>
                </thead>
                <tbody>
          `;
          
          result.parametros.forEach(param => {
            const requerido = param.requerido ? '<span class="pill aprobada">S√≠</span>' : '<span class="pill borrador">No</span>';
            const tipo = getTipoParametroLabel(param.tipo);
            const opciones = param.opciones_list ? param.opciones_list.join(', ') : '-';
            
            html += `
              <tr>
                <td><strong>${param.nombre}</strong></td>
                <td>${tipo}</td>
                <td>${requerido}</td>
                <td>${param.valor_por_defecto || '-'}</td>
                <td style="font-size: 0.85rem;">${opciones}</td>
              </tr>
            `;
          });
          
          html += `
                </tbody>
              </table>
            </div>
          `;
          
          contenido.innerHTML = html;
        }
        
        document.getElementById('modal-parametros').dataset.servicioId = servicioId;
        
      } else {
        contenido.innerHTML = `
          <div style="text-align: center; padding: 20px; color: var(--rojo-600);">
            <p>Error al cargar los par√°metros: ${result.error}</p>
          </div>
        `;
      }
      
    } catch (error) {
      console.error('Error cargando par√°metros:', error);
      document.getElementById('parametros-contenido').innerHTML = `
        <div style="text-align: center; padding: 20px; color: var(--rojo-600);">
          <p>Error al cargar los par√°metros del servicio</p>
        </div>
      `;
    }
  }

  function getTipoParametroLabel(tipo) {
    const tipos = {
      'text': 'Texto',
      'number': 'N√∫mero',
      'select': 'Selecci√≥n',
      'boolean': 'S√≠/No'
    };
    return tipos[tipo] || tipo;
  }

  function editarParametros() {
    const servicioId = document.getElementById('modal-parametros').dataset.servicioId;
    cerrarModal('modal-parametros');
    window.location.href = `/cotizaciones/servicio/${servicioId}/parametros/gestionar/`;
  }

  function abrirGestionParametros(servicioId) {
    window.location.href = `/cotizaciones/servicio/${servicioId}/parametros/gestionar/`;
  }
  
  function cerrarModalServicio() {
    document.getElementById('modal-servicio-titulo').textContent = 'Nuevo Servicio';
    document.getElementById('servicio-id').value = '';
    document.getElementById('form-servicio').reset();
    document.getElementById('servicio-parametrizable').checked = false;
    document.getElementById('servicio-activo').checked = true;
    document.getElementById('modal-servicio').classList.remove('show');
  }
  
  document.getElementById('form-servicio').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = {
      categoria_id: document.getElementById('servicio-categoria').value,
      nombre: document.getElementById('servicio-nombre').value,
      descripcion: document.getElementById('servicio-descripcion').value,
      precio_base: document.getElementById('servicio-precio').value,
      unidad: document.getElementById('servicio-unidad').value,
      es_parametrizable: document.getElementById('servicio-parametrizable').checked,
      activo: document.getElementById('servicio-activo').checked
    };
    
    const servicioId = document.getElementById('servicio-id').value;
    const isEditing = servicioId !== '';
    
    try {
      const url = isEditing ? 
        `/cotizaciones/servicio/${servicioId}/editar/` : 
        '/cotizaciones/servicio/crear/';
      
      const method = isEditing ? 'PUT' : 'POST';
      
      const response = await fetch(url, {
        method: method,
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCSRFToken()
        },
        body: JSON.stringify(formData)
      });
      
      const result = await response.json();
      
      if (result.success) {
        alert(result.message);
        cerrarModalServicio();
        location.reload();
      } else {
        alert('Error: ' + result.error);
      }
      
    } catch (error) {
      console.error('Error guardando servicio:', error);
      alert('Error al guardar el servicio');
    }
  });
  
  document.getElementById('form-categoria').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const categoriaId = document.getElementById('categoria-id').value;
    const isEditing = categoriaId !== '';
    
    const formData = {
      nombre: document.getElementById('categoria-nombre').value,
      descripcion: document.getElementById('categoria-descripcion').value,
      orden: document.getElementById('categoria-orden').value
    };
    
    try {
      const url = isEditing ? 
        `/cotizaciones/categoria-servicio/${categoriaId}/editar/` : 
        '/cotizaciones/categoria-servicio/crear/';
      
      const method = isEditing ? 'PUT' : 'POST';
      
      const response = await fetch(url, {
        method: method,
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCSRFToken()
        },
        body: JSON.stringify(formData)
      });
      
      const result = await response.json();
      
      if (result.success) {
        alert(result.message);
        cerrarModal('modal-categoria');
        location.reload();
      } else {
        alert('Error: ' + result.error);
      }
      
    } catch (error) {
      console.error('Error guardando categor√≠a:', error);
      alert('Error al guardar la categor√≠a');
    }
  });
  
  // Funci√≥n para editar categor√≠a
  async function editarCategoria(categoriaId) {
    try {
      const response = await fetch(`/cotizaciones/categoria-servicio/${categoriaId}/`);
      const result = await response.json();
      
      if (result.success) {
        document.getElementById('modal-categoria-titulo').textContent = 'Editar Categor√≠a';
        document.getElementById('categoria-id').value = categoriaId;
        document.getElementById('categoria-nombre').value = result.categoria.nombre;
        document.getElementById('categoria-descripcion').value = result.categoria.descripcion || '';
        document.getElementById('categoria-orden').value = result.categoria.orden || 0;
        
        cerrarModal('modal-ver-categorias');
        mostrarModal('modal-categoria');
      } else {
        alert('Error al cargar los datos de la categor√≠a: ' + result.error);
      }
    } catch (error) {
      console.error('Error cargando categor√≠a:', error);
      alert('Error al cargar los datos de la categor√≠a');
    }
  }
  
  // Funci√≥n para eliminar categor√≠a
  async function eliminarCategoria(categoriaId, nombreCategoria) {
    if (!confirm(`¬øEst√°s seguro de eliminar la categor√≠a "${nombreCategoria}"?\n\nEsto podr√≠a afectar a los servicios asociados.`)) {
      return;
    }
    
    try {
      const response = await fetch(`/cotizaciones/categoria-servicio/${categoriaId}/eliminar/`, {
        method: 'DELETE',
        headers: {
          'X-CSRFToken': getCSRFToken()
        }
      });
      
      const result = await response.json();
      
      if (result.success) {
        alert(result.message);
        location.reload();
      } else {
        alert('Error: ' + result.error);
      }
      
    } catch (error) {
      console.error('Error eliminando categor√≠a:', error);
      alert('Error al eliminar la categor√≠a');
    }
  }
  
  // Funci√≥n para abrir modal de nueva categor√≠a desde el modal de ver categor√≠as
  function abrirNuevaCategoria() {
    cerrarModal('modal-ver-categorias');
    mostrarModal('modal-categoria');
  }
  
  // Limpiar formulario de categor√≠a al cerrar
  function cerrarModalCategoria() {
    document.getElementById('modal-categoria-titulo').textContent = 'Nueva Categor√≠a';
    document.getElementById('categoria-id').value = '';
    document.getElementById('form-categoria').reset();
    cerrarModal('modal-categoria');
    // Volver a abrir el modal de ver categor√≠as
    mostrarModal('modal-ver-categorias');
  }
  
  // ===== FILTROS Y ORDENAMIENTO DEL MODAL DE CATEGOR√çAS =====
  
  // Filtrar categor√≠as en el modal
  function filtrarCategorias() {
    const busqueda = document.getElementById('filtro-categoria-nombre').value.toLowerCase();
    const tbody = document.getElementById('tbody-categorias');
    const filas = tbody.querySelectorAll('tr:not(#row-sin-categorias)');
    const sinResultados = document.getElementById('sin-resultados-categorias');
    
    let visibles = 0;
    
    filas.forEach(fila => {
      const nombre = fila.getAttribute('data-nombre') || '';
      const mostrar = nombre.includes(busqueda);
      
      fila.style.display = mostrar ? '' : 'none';
      if (mostrar) visibles++;
    });
    
    // Mostrar u ocultar mensaje de sin resultados
    if (visibles === 0 && filas.length > 0) {
      sinResultados.style.display = 'block';
      tbody.style.display = 'none';
    } else {
      sinResultados.style.display = 'none';
      tbody.style.display = '';
    }
  }
  
  // Limpiar filtros de categor√≠as
  function limpiarFiltrosCategorias() {
    document.getElementById('filtro-categoria-nombre').value = '';
    filtrarCategorias();
  }
  
  // Ordenar categor√≠as en el modal
  let ordenCategorias = {
    columna: null,
    ascendente: true
  };
  
  function ordenarCategorias(columna) {
    const tbody = document.getElementById('tbody-categorias');
    const filas = Array.from(tbody.querySelectorAll('tr:not(#row-sin-categorias)'));
    
    // Si es la misma columna, invertir orden
    if (ordenCategorias.columna === columna) {
      ordenCategorias.ascendente = !ordenCategorias.ascendente;
    } else {
      ordenCategorias.columna = columna;
      ordenCategorias.ascendente = true;
    }
    
    // Ordenar filas
    filas.sort((a, b) => {
      let valorA, valorB;
      
      if (columna === 'nombre') {
        valorA = a.getAttribute('data-nombre') || '';
        valorB = b.getAttribute('data-nombre') || '';
      } else if (columna === 'orden') {
        valorA = parseInt(a.getAttribute('data-orden')) || 0;
        valorB = parseInt(b.getAttribute('data-orden')) || 0;
      } else if (columna === 'servicios') {
        valorA = parseInt(a.getAttribute('data-servicios')) || 0;
        valorB = parseInt(b.getAttribute('data-servicios')) || 0;
      }
      
      if (valorA < valorB) return ordenCategorias.ascendente ? -1 : 1;
      if (valorA > valorB) return ordenCategorias.ascendente ? 1 : -1;
      return 0;
    });
    
    // Reorganizar filas en el DOM
    filas.forEach(fila => tbody.appendChild(fila));
    
    // Actualizar iconos de ordenamiento
    document.querySelectorAll('#tabla-categorias-modal thead span[id^="sort-"]').forEach(span => {
      span.textContent = '‚áÖ';
    });
    
    const icono = document.getElementById(`sort-${columna}`);
    if (icono) {
      icono.textContent = ordenCategorias.ascendente ? '‚ñ≤' : '‚ñº';
    }
  }
  
  // Sobrescribir el cierre del modal de categor√≠a
  document.querySelector('#modal-categoria .close').onclick = function() {
    cerrarModalCategoria();
  };
  
  document.querySelector('#modal-servicio .close').onclick = function() {
    cerrarModalServicio();
  };

  function toggleExportMenu(menuId) {
    const menu = document.getElementById(menuId);
    const allMenus = document.querySelectorAll('.export-menu');
    
    allMenus.forEach(m => {
      if (m.id !== menuId) {
        m.style.display = 'none';
      }
    });
    
    menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
  }

  document.addEventListener('click', function(event) {
    if (!event.target.closest('.dropdown-export')) {
      document.querySelectorAll('.export-menu').forEach(menu => {
        menu.style.display = 'none';
      });
    }
  });
  
  // ===== SISTEMA DE FILTROS INTERACTIVOS =====

  function aplicarFiltros() {
    const busqueda = document.getElementById('busqueda').value.toLowerCase();
    const categoria = document.getElementById('categoria').value;
    const parametrizable = document.getElementById('filtro-parametrizable').value;
    const estado = document.getElementById('filtro-estado').value;
    
    const filas = document.querySelectorAll('#tabla-servicios tbody tr');
    let visibles = 0;
    
    filas.forEach(fila => {
      if (fila.cells.length === 1) return; // Fila de "sin resultados"
      
      const textoFila = fila.textContent.toLowerCase();
      const categoriaFila = fila.dataset.categoria;
      const parametrizableFila = fila.dataset.parametrizable;
      const estadoFila = fila.dataset.estado;
      
      let mostrar = true;
      
      // Filtro de b√∫squeda
      if (busqueda && !textoFila.includes(busqueda)) {
        mostrar = false;
      }
      
      // Filtro de categor√≠a
      if (categoria && categoriaFila !== categoria) {
        mostrar = false;
      }
      
      // Filtro de parametrizable
      if (parametrizable && parametrizableFila !== parametrizable) {
        mostrar = false;
      }
      
      // Filtro de estado
      if (estado && estadoFila !== estado) {
        mostrar = false;
      }
      
      fila.style.display = mostrar ? '' : 'none';
      if (mostrar) visibles++;
    });
    
    // Actualizar mensaje si no hay resultados
    actualizarMensajeSinResultados(visibles);
  }
  
  function actualizarMensajeSinResultados(visibles) {
    const tbody = document.querySelector('#tabla-servicios tbody');
    let filaMensaje = tbody.querySelector('.fila-sin-resultados');
    
    if (visibles === 0) {
      if (!filaMensaje) {
        filaMensaje = document.createElement('tr');
        filaMensaje.className = 'fila-sin-resultados';
        filaMensaje.innerHTML = `
          <td colspan="7" style="text-align: center; padding: 40px; color: var(--gris-600);">
            No se encontraron servicios que coincidan con los filtros aplicados.
            <br><br>
            <button type="button" class="btn secondary" onclick="limpiarFiltros()">
              Limpiar Filtros
            </button>
          </td>
        `;
        tbody.appendChild(filaMensaje);
      }
    } else if (filaMensaje) {
      filaMensaje.remove();
    }
  }
  
  function limpiarFiltros() {
    document.getElementById('busqueda').value = '';
    document.getElementById('categoria').value = '';
    document.getElementById('filtro-parametrizable').value = '';
    document.getElementById('filtro-estado').value = '';
    
    // Limpiar visuales de KPIs
    document.querySelectorAll('.cards .card').forEach(card => {
      card.classList.remove('active');
    });
    
    aplicarFiltros();
  }
  
  function filtrarPorCategoria(categoriaId, categoriaNombre) {
    cerrarModal('modal-ver-categorias');
    document.getElementById('categoria').value = categoriaId;
    aplicarFiltros();
    
    // Marcar KPI de categor√≠as como activo
    const kpiCategorias = document.getElementById('kpi-categorias');
    document.querySelectorAll('.cards .card').forEach(card => card.classList.remove('active'));
    kpiCategorias.classList.add('active');
  }
  
  // ===== SISTEMA DE FILTROS R√ÅPIDOS PARA KPIs DE SERVICIOS =====

  function initFiltrosRapidosServicios() {
    const kpiTotal = document.querySelector('#kpi-total-servicios');
    const kpiParametrizables = document.querySelector('#kpi-parametrizables');
    const kpiCategorias = document.querySelector('#kpi-categorias');
    const kpiActivos = document.querySelector('#kpi-activos');
    
    const inputBusqueda = document.querySelector('#busqueda');
    const selectCategoria = document.querySelector('#categoria');
    const selectParametrizable = document.querySelector('#filtro-parametrizable');
    const selectEstado = document.querySelector('#filtro-estado');
    
    if (!kpiTotal || !inputBusqueda) return;
    
    function limpiarFiltrosVisuales() {
      document.querySelectorAll('.cards .card').forEach(card => {
        card.classList.remove('active');
      });
    }
    
    function limpiarTodosFiltros() {
      if (inputBusqueda) inputBusqueda.value = '';
      if (selectCategoria) selectCategoria.value = '';
      if (selectParametrizable) selectParametrizable.value = '';
      if (selectEstado) selectEstado.value = '';
    }
    
    function ejecutarFiltro() {
      aplicarFiltros();
    }
    
    // 1. Total Servicios - Limpiar todo
    kpiTotal.addEventListener('click', function(e) {
      createRipple(e, this);
      if (navigator.vibrate) navigator.vibrate(10);
      
      const yaEstaActiva = this.classList.contains('active');
      
      if (yaEstaActiva) {
        limpiarFiltrosVisuales();
        limpiarTodosFiltros();
        ejecutarFiltro();
        return;
      }
      
      setTimeout(() => {
        limpiarFiltrosVisuales();
        this.classList.add('active');
        limpiarTodosFiltros();
        ejecutarFiltro();
      }, 100);
    });
    
    // 2. Parametrizables - Filtrar solo parametrizables
    kpiParametrizables.addEventListener('click', function(e) {
      createRipple(e, this);
      if (navigator.vibrate) navigator.vibrate(10);
      
      const yaEstaActiva = this.classList.contains('active');
      
      if (yaEstaActiva) {
        limpiarFiltrosVisuales();
        limpiarTodosFiltros();
        ejecutarFiltro();
        return;
      }
      
      setTimeout(() => {
        limpiarFiltrosVisuales();
        this.classList.add('active');
        limpiarTodosFiltros();
        if (selectParametrizable) selectParametrizable.value = 'si';
        ejecutarFiltro();
      }, 100);
    });
    
    // 3. Categor√≠as - Mostrar modal de categor√≠as
    kpiCategorias.addEventListener('click', function(e) {
      createRipple(e, this);
      if (navigator.vibrate) navigator.vibrate(10);
      
      setTimeout(() => {
        mostrarModal('modal-ver-categorias');
      }, 100);
    });
    
    // 4. Activos - Filtrar solo activos
    kpiActivos.addEventListener('click', function(e) {
      createRipple(e, this);
      if (navigator.vibrate) navigator.vibrate(10);
      
      const yaEstaActiva = this.classList.contains('active');
      
      if (yaEstaActiva) {
        limpiarFiltrosVisuales();
        limpiarTodosFiltros();
        ejecutarFiltro();
        return;
      }
      
      setTimeout(() => {
        limpiarFiltrosVisuales();
        this.classList.add('active');
        limpiarTodosFiltros();
        if (selectEstado) selectEstado.value = 'activo';
        ejecutarFiltro();
      }, 100);
    });
  }

  // Efecto ripple mejorado
  function createRipple(event, element) {
    const ripple = document.createElement('span');
    const rect = element.getBoundingClientRect();
    const size = Math.max(rect.width, rect.height);
    const x = event.clientX - rect.left - size / 2;
    const y = event.clientY - rect.top - size / 2;
    
    ripple.style.width = ripple.style.height = size + 'px';
    ripple.style.left = x + 'px';
    ripple.style.top = y + 'px';
    ripple.classList.add('ripple-effect');
    
    element.appendChild(ripple);
    
    setTimeout(() => {
      ripple.remove();
    }, 600);
  }
  
  // Event listeners para filtros
  document.getElementById('busqueda').addEventListener('input', aplicarFiltros);
  document.getElementById('categoria').addEventListener('change', aplicarFiltros);
  document.getElementById('filtro-parametrizable').addEventListener('change', aplicarFiltros);
  document.getElementById('filtro-estado').addEventListener('change', aplicarFiltros);
  
  // Inicializar cuando carga la p√°gina
  document.addEventListener('DOMContentLoaded', function() {
    initFiltrosRapidosServicios();
  });

  // Evitar que los modales se cierren al hacer clic fuera
  document.getElementById('modal-servicio').addEventListener('click', function(e) {
    // Solo cerrar si se hace clic directamente en el fondo del modal
    // PERO no hacemos nada aqu√≠, dejamos que solo el bot√≥n X y Cancel cierren
    if (e.target === this) {
      e.stopPropagation(); // Evitar que se cierre
    }
  });

  document.getElementById('modal-categoria').addEventListener('click', function(e) {
    if (e.target === this) {
      e.stopPropagation();
    }
  });

  document.getElementById('modal-ver-categorias').addEventListener('click', function(e) {
    if (e.target === this) {
      e.stopPropagation();
    }
  });

  document.getElementById('modal-parametros').addEventListener('click', function(e) {
    if (e.target === this) {
      e.stopPropagation();
    }
  });

</script>
</body>
</html>